<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Immunization Tracker - Ghana Health Service</title>
  
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#006400">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Immunization Tracker">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <link rel="icon" href="/icons/icon-192x192.png">
  
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut,
      sendPasswordResetEmail,
      onAuthStateChanged,
      updatePassword,
      EmailAuthProvider,
      reauthenticateWithCredential,
      deleteUser as deleteFirebaseUser
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      updateDoc, 
      deleteDoc, 
      doc, 
      getDoc, 
      getDocs, 
      query, 
      where, 
      orderBy,
      setDoc,
      serverTimestamp,
      increment,
      onSnapshot,
      Timestamp,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBJyFKIHjg8bmvHPEoT3ObZlbbHWdwT_Eg",
      authDomain: "immunization-system-tracker.firebaseapp.com",
      projectId: "immunization-system-tracker",
      storageBucket: "immunization-system-tracker.firebasestorage.app",
      messagingSenderId: "1086245008022",
      appId: "1:1086245008022:web:c7604061fd7df25efc48b7",
      measurementId: "G-RYQYNEW47T"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.firebase = {
      app: app,
      auth: {
        getAuth: () => auth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        sendPasswordResetEmail,
        onAuthStateChanged,
        updatePassword,
        EmailAuthProvider,
        reauthenticateWithCredential,
        deleteFirebaseUser
      },
      firestore: {
        getFirestore: () => db,
        collection,
        addDoc,
        updateDoc,
        deleteDoc,
        doc,
        getDoc,
        getDocs,
        query,
        where,
        orderBy,
        setDoc,
        serverTimestamp,
        increment,
        onSnapshot,
        Timestamp,
        writeBatch
      }
    };
  </script>

  <style>
    :root {
      --ghs-green: #006400;
      --ghs-green-dark: #004d00;
      --ghs-green-light: #e8f5e8;
      --ghs-gold: #FFD700;
      --ghs-red: #CE1126;
      --ghs-yellow: #FCD116;
      --ghs-blue: #0066CC;
      --ghs-white: #FFFFFF;
      --ghs-light: #F8FAFC;
      --ghs-gray: #64748B;
      --ghs-dark: #1E293B;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --radius-lg: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --elevation-1: 0 2px 4px rgba(0,0,0,0.1);
      --elevation-2: 0 4px 8px rgba(0,0,0,0.12);
      --elevation-3: 0 8px 16px rgba(0,0,0,0.14);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: #f5f5f5;
      color: var(--ghs-dark);
      line-height: 1.6;
      min-height: 100vh;
      font-weight: 400;
    }

    #authScreen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--ghs-green) 0%, var(--ghs-green-dark) 100%);
      padding: 20px;
    }

    #appScreen {
      display: none;
    }

    .auth-container {
      background: var(--ghs-white);
      border-radius: var(--radius-lg);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: var(--elevation-3);
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .auth-logo {
      font-size: 64px;
      text-align: center;
      margin-bottom: 16px;
      color: var(--ghs-green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .auth-title {
      text-align: center;
      color: var(--ghs-green);
      margin-bottom: 8px;
      font-size: 24px;
      font-weight: 700;
    }

    .auth-subtitle {
      text-align: center;
      color: var(--ghs-gray);
      margin-bottom: 32px;
      font-size: 14px;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .auth-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: var(--transition);
      background: var(--ghs-white);
    }

    .auth-input:focus {
      border-color: var(--ghs-green);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.1);
    }

    .auth-button {
      background: var(--ghs-green);
      color: var(--ghs-white);
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      font-size: 16px;
      margin-top: 10px;
    }

    .auth-button:hover {
      background: var(--ghs-green-dark);
      transform: translateY(-2px);
      box-shadow: var(--elevation-2);
    }

    .auth-button.secondary {
      background: var(--ghs-blue);
    }

    .auth-button.outlined {
      background: transparent;
      border: 2px solid var(--ghs-green);
      color: var(--ghs-green);
    }

    .auth-switch {
      text-align: center;
      margin-top: 24px;
      color: var(--ghs-gray);
      font-size: 14px;
    }

    .auth-switch a {
      color: var(--ghs-green);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .auth-switch a:hover {
      text-decoration: underline;
    }

    .form-group {
      position: relative;
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--ghs-gray);
      padding: 5px;
      border-radius: 4px;
      transition: var(--transition);
    }

    .password-toggle:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .forgot-password {
      text-align: center;
      color: var(--ghs-blue);
      text-decoration: none;
      font-size: 14px;
      margin-top: -8px;
      cursor: pointer;
      transition: var(--transition);
    }

    .forgot-password:hover {
      text-decoration: underline;
    }

    .auth-error {
      color: var(--ghs-red);
      font-size: 14px;
      margin-top: -8px;
      padding: 8px;
      background: rgba(206, 17, 38, 0.1);
      border-radius: 6px;
      display: none;
    }

    .app-header {
      background: var(--ghs-green);
      color: var(--ghs-white);
      padding: 16px 20px;
      box-shadow: var(--elevation-2);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }

    .facility-info h1 {
      font-size: 20px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .facility-name {
      font-size: 14px;
      opacity: 0.9;
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .nav-menu {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .nav-link {
      color: var(--ghs-white);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      font-size: 14px;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .nav-link.active {
      background: rgba(255, 255, 255, 0.2);
      font-weight: 600;
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .user-name {
      font-size: 14px;
      font-weight: 500;
    }

    .user-email {
      font-size: 12px;
      opacity: 0.8;
    }

    .menu-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--ghs-white);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .menu-toggle:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: var(--ghs-white);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }

    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    section {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    .active-section {
      display: block;
    }

    .mui-paper {
      background: var(--ghs-white);
      border-radius: var(--radius);
      box-shadow: var(--elevation-1);
      padding: 24px;
      margin-bottom: 24px;
      transition: var(--transition);
    }

    .mui-paper:hover {
      box-shadow: var(--elevation-2);
    }

    .mui-card {
      background: var(--ghs-white);
      border-radius: var(--radius);
      box-shadow: var(--elevation-1);
      padding: 20px;
      margin-bottom: 16px;
      border-left: 4px solid var(--ghs-green);
    }

    .mui-button {
      background: var(--ghs-green);
      color: var(--ghs-white);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .mui-button:hover {
      background: var(--ghs-green-dark);
      transform: translateY(-2px);
      box-shadow: var(--elevation-2);
    }

    .mui-button.secondary {
      background: var(--ghs-blue);
    }

    .mui-button.outlined {
      background: transparent;
      border: 2px solid var(--ghs-green);
      color: var(--ghs-green);
    }

    .mui-button.danger {
      background: var(--ghs-red);
    }

    .mui-textfield {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: var(--transition);
      background: var(--ghs-white);
    }

    .mui-textfield:focus {
      border-color: var(--ghs-green);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.1);
    }

    .mui-select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      background: var(--ghs-white);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23006400' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }

    .stat-card {
      background: var(--ghs-white);
      border-radius: var(--radius);
      padding: 24px;
      text-align: center;
      box-shadow: var(--elevation-1);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--elevation-2);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--ghs-green);
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--ghs-green);
      margin: 8px 0;
    }

    .mui-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      background: var(--ghs-white);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--elevation-1);
    }

    .mui-table th {
      background: var(--ghs-green);
      color: var(--ghs-white);
      padding: 16px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .mui-table td {
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .mui-table tr:hover {
      background: var(--ghs-green-light);
    }

    .chart-container {
      background: var(--ghs-white);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--elevation-1);
      height: 400px;
      position: relative;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--ghs-green);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin: 24px 0;
    }

    .mui-tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .mui-tab {
      padding: 16px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 500;
      color: var(--ghs-gray);
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      white-space: nowrap;
    }

    .mui-tab.active {
      color: var(--ghs-green);
      border-bottom: 3px solid var(--ghs-green);
    }

    .mui-chip {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }

    .mui-chip.upcoming {
      background: #e3f2fd;
      color: #1565c0;
    }

    .mui-chip.due {
      background: #fff3e0;
      color: #ef6c00;
    }

    .mui-chip.defaulted {
      background: #ffebee;
      color: #c62828;
    }

    .mui-chip.completed {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: var(--radius);
      box-shadow: var(--elevation-2);
      z-index: 2000;
      animation: slideIn 0.3s ease-out;
      max-width: 400px;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(10px);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success {
      background: linear-gradient(135deg, var(--ghs-green) 0%, var(--ghs-green-dark) 100%);
      color: var(--ghs-white);
    }

    .notification.error {
      background: linear-gradient(135deg, var(--ghs-red) 0%, #a00 100%);
      color: var(--ghs-white);
    }

    .notification.info {
      background: linear-gradient(135deg, var(--ghs-blue) 0%, #004d99 100%);
      color: var(--ghs-white);
    }

    .notification.warning {
      background: linear-gradient(135deg, var(--ghs-yellow) 0%, #e6b400 100%);
      color: var(--ghs-dark);
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      backdrop-filter: blur(5px);
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--ghs-green-light);
      border-top-color: var(--ghs-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .offline-indicator {
      background: var(--ghs-red);
      color: var(--ghs-white);
      padding: 12px 20px;
      text-align: center;
      position: sticky;
      top: 70px;
      z-index: 999;
      display: none;
      font-weight: 500;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 20px;
      animation: fadeIn 0.3s ease-out;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--ghs-white);
      border-radius: var(--radius-lg);
      padding: 32px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      animation: scaleIn 0.3s ease-out;
    }

    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .close {
      font-size: 28px;
      cursor: pointer;
      color: var(--ghs-gray);
      transition: var(--transition);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close:hover {
      color: var(--ghs-red);
      background: rgba(0, 0, 0, 0.05);
    }

    #mobileMenu {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      padding: 20px;
      animation: fadeIn 0.3s ease-out;
    }

    .mobile-menu-content {
      background: var(--ghs-white);
      border-radius: var(--radius-lg);
      padding: 20px;
      height: 100%;
      animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .mobile-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .mobile-nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      color: var(--ghs-dark);
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: var(--transition);
      font-weight: 500;
    }

    .mobile-nav-link:hover {
      background: var(--ghs-green-light);
    }

    .mobile-nav-link.active {
      background: var(--ghs-green);
      color: var(--ghs-white);
    }

    footer {
      text-align: center;
      padding: 20px;
      color: var(--ghs-gray);
      font-size: 14px;
      border-top: 1px solid #e0e0e0;
      margin-top: 40px;
      background: var(--ghs-white);
    }

    @media (max-width: 1024px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        height: 350px;
      }
    }

    @media (max-width: 768px) {
      .nav-menu {
        display: none;
      }
      
      .menu-toggle {
        display: block;
      }
      
      .user-info {
        display: none;
      }
      
      .chart-container {
        height: 300px;
        padding: 16px;
      }
      
      .filter-grid {
        grid-template-columns: 1fr;
      }
      
      .auth-container {
        padding: 24px;
        margin: 10px;
      }
      
      .modal-content {
        padding: 20px;
      }
      
      .header-content {
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .facility-info h1 {
        font-size: 16px;
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .auth-container {
        padding: 20px;
      }
      
      .mui-paper {
        padding: 16px;
      }
      
      .mui-table {
        font-size: 14px;
      }
      
      .mui-table th,
      .mui-table td {
        padding: 12px 8px;
      }
    }

    .account-management {
      background: var(--ghs-white);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--elevation-1);
    }

    .account-section {
      margin-bottom: 32px;
    }

    .account-section h3 {
      color: var(--ghs-green);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--ghs-green-light);
    }

    .account-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      font-weight: 500;
      color: var(--ghs-dark);
      font-size: 14px;
    }

    .input-hint {
      font-size: 12px;
      color: var(--ghs-gray);
      margin-top: -6px;
    }

    .danger-zone {
      background: rgba(206, 17, 38, 0.05);
      border: 2px solid rgba(206, 17, 38, 0.2);
      border-radius: var(--radius);
      padding: 24px;
      margin-top: 32px;
    }

    .danger-zone h4 {
      color: var(--ghs-red);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .role-badge {
      background: var(--ghs-green);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .role-badge.admin {
      background: var(--ghs-red);
    }

    .role-badge.staff {
      background: var(--ghs-blue);
    }

    .role-badge.user {
      background: var(--ghs-gray);
    }

    .user-table-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .user-table-actions button {
      padding: 4px 8px;
      font-size: 12px;
    }

    .password-strength {
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      width: 0%;
      transition: var(--transition);
    }

    .strength-weak {
      background: var(--ghs-red);
    }

    .strength-fair {
      background: var(--ghs-yellow);
    }

    .strength-good {
      background: var(--ghs-green);
    }

    .strength-strong {
      background: var(--ghs-green-dark);
    }

    .call-button {
      background: #006400;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      transition: var(--transition);
    }

    .call-button:hover {
      background: #004d00;
      transform: translateY(-1px);
    }

    .call-button:disabled {
      background: var(--ghs-gray);
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .defaulters-table {
      max-height: 500px;
      overflow-y: auto;
      margin-top: 20px;
    }
    
    .defaulters-table .mui-table {
      font-size: 13px;
    }
    
    .defaulters-table .mui-table th {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    #installPWAButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      display: none;
    }
  </style>
</head>
<body>
  <div id="authScreen">
    <div class="auth-container">
      <div class="auth-logo">üè•</div>
      <h1 class="auth-title">Immunization Tracker</h1>
      <p class="auth-subtitle">Ghana Health Service - No Child Left Behind</p>
      
      <form id="loginForm" class="auth-form">
        <div class="form-group">
          <input type="email" id="loginEmail" class="auth-input" placeholder="Email" required>
          <div id="loginEmailError" class="auth-error"></div>
        </div>
        
        <div class="form-group">
          <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
          <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">üëÅÔ∏è</button>
          <div id="loginPasswordError" class="auth-error"></div>
        </div>
        
        <button type="submit" class="auth-button">Login</button>
        <a href="#" class="forgot-password" onclick="showForgotPassword()">Forgot Password?</a>
      </form>
      
      <form id="signupForm" class="auth-form" style="display: none;">
        <div class="form-group">
          <input type="text" id="signupName" class="auth-input" placeholder="Full Name" required>
          <div id="signupNameError" class="auth-error"></div>
        </div>
        
        <div class="form-group">
          <input type="text" id="signupFacility" class="auth-input" placeholder="Health Facility Name" required>
          <div id="signupFacilityError" class="auth-error"></div>
        </div>
        
        <div class="form-group">
          <input type="email" id="signupEmail" class="auth-input" placeholder="Email" required>
          <div id="signupEmailError" class="auth-error"></div>
        </div>
        
        <div class="form-group">
          <input type="password" id="signupPassword" class="auth-input" placeholder="Password (min. 6 characters)" required minlength="6">
          <button type="button" class="password-toggle" onclick="togglePassword('signupPassword')">üëÅÔ∏è</button>
          <div id="signupPasswordError" class="auth-error"></div>
          <div class="password-strength">
            <div id="passwordStrengthBar" class="password-strength-bar"></div>
          </div>
        </div>
        
        <div class="form-group">
          <input type="password" id="signupConfirmPassword" class="mui-textfield" placeholder="Confirm Password" required>
          <button type="button" class="password-toggle" onclick="togglePassword('signupConfirmPassword')">üëÅÔ∏è</button>
          <div id="signupConfirmPasswordError" class="auth-error"></div>
        </div>
        
        <button type="submit" class="auth-button">Create Facility Account</button>
      </form>
      
      <form id="forgotPasswordForm" class="auth-form" style="display: none;">
        <div class="form-group">
          <input type="email" id="resetEmail" class="auth-input" placeholder="Enter your email" required>
          <div id="resetEmailError" class="auth-error"></div>
        </div>
        
        <button type="submit" class="auth-button">Reset Password</button>
        <button type="button" class="auth-button secondary" onclick="showLogin()">Back to Login</button>
      </form>
      
      <div class="auth-switch">
        <span id="switchText">Don't have an account? </span>
        <a href="#" id="switchLink" onclick="toggleAuthForm()">Sign up</a>
      </div>
    </div>
  </div>

  <div id="appScreen">
    <header class="app-header">
      <div class="header-content">
        <div class="facility-info">
          <h1>üè• Immunization Tracker</h1>
          <div id="currentFacility" class="facility-name">Loading...</div>
        </div>
        
        <nav class="nav-menu">
          <a href="#" class="nav-link active" onclick="showSection('home')">
            <span class="material-icons">home</span> Home
          </a>
          <a href="#" class="nav-link" onclick="showSection('registration')">
            <span class="material-icons">person_add</span> Register Child
          </a>
          <a href="#" class="nav-link" onclick="showSection('register')">
            <span class="material-icons">list_alt</span> Child Register
          </a>
          <a href="#" class="nav-link" onclick="showSection('defaulters')">
            <span class="material-icons">warning</span> Defaulters
          </a>
          <a href="#" class="nav-link" onclick="showSection('dashboard')">
            <span class="material-icons">dashboard</span> Dashboard
          </a>
          <a href="#" class="nav-link" onclick="showSection('reporting')">
            <span class="material-icons">analytics</span> Reports
          </a>
          <a href="#" class="nav-link" onclick="showSection('accountManagement')">
            <span class="material-icons">manage_accounts</span> Account
          </a>
          <a href="#" class="nav-link" onclick="showSection('settings')">
            <span class="material-icons">settings</span> Settings
          </a>
        </nav>
        
        <div class="user-actions">
          <div class="user-info">
            <div id="currentUserName" class="user-name">Loading...</div>
            <div id="currentUserEmail" class="user-email">Loading...</div>
          </div>
          <button class="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
          <button onclick="logout()" class="logout-btn">
            <span class="material-icons">logout</span> Logout
          </button>
        </div>
      </div>
    </header>

    <div id="offlineIndicator" class="offline-indicator">
      ‚ö†Ô∏è You are currently offline. The app will work with limited functionality.
    </div>

    <div id="mobileMenu" style="display: none;">
      <div class="mobile-menu-content">
        <div class="mobile-menu-header">
          <h3>Menu</h3>
          <button onclick="toggleMobileMenu()" class="close">√ó</button>
        </div>
        <a href="#" class="mobile-nav-link active" onclick="showSection('home'); toggleMobileMenu();">
          <span class="material-icons">home</span> Home
        </a>
        <a href="#" class="mobile-nav-link" onclick="showSection('registration'); toggleMobileMenu();">
          <span class="material-icons">person_add</span> Register Child
        </a>
        <a href="#" class="mobile-nav-link" onclick="showSection('register'); toggleMobileMenu();">
          <span class="material-icons">list_alt</span> Child Register
        </a>
        <a href="#" class="mobile-nav-link" onclick="showSection('defaulters'); toggleMobileMenu();">
          <span class="material-icons">warning</span> Defaulters
        </a>
        <a href="#" class="mobile-nav-link" onclick="showSection('dashboard'); toggleMobileMenu();">
          <span class="material-icons">dashboard</span> Dashboard
        </a>
        <a href="#" class="mobile-nav-link" onclick="showSection('reporting'); toggleMobileMenu();">
          <span class="material-icons">analytics</span> Reports
        </a>
        <a href="#" class="mobile-nav-link" onclick="showSection('accountManagement'); toggleMobileMenu();">
          <span class="material-icons">manage_accounts</span> Account
        </a>
        <a href="#" class="mobile-nav-link" onclick="showSection('settings'); toggleMobileMenu();">
          <span class="material-icons">settings</span> Settings
        </a>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
          <button onclick="logout(); toggleMobileMenu();" class="logout-btn" style="width: 100%; justify-content: center;">
            <span class="material-icons">logout</span> Logout
          </button>
        </div>
      </div>
    </div>

    <div class="main-content">
      <section id="home" class="active-section">
        <div class="mui-paper">
          <h2>üè† Welcome to Immunization Tracker</h2>
          <p class="auth-subtitle">2030 EPI Agenda - No Child Left Behind</p>
          
          <div class="stats-container">
            <div class="stat-card">
              <h3>Total Children (0-59 months)</h3>
              <div class="stat-value" id="totalChildren">0</div>
            </div>
            <div class="stat-card">
              <h3>Vaccinated Today</h3>
              <div class="stat-value" id="vaccinatedToday">0</div>
            </div>
            <div class="stat-card">
              <h3>Due Soon (7 days)</h3>
              <div class="stat-value" id="dueSoon">0</div>
            </div>
            <div class="stat-card">
              <h3>Active Defaulters</h3>
              <div class="stat-value" id="defaulters">0</div>
            </div>
          </div>

          <div class="quick-actions">
            <button class="mui-button" onclick="showSection('registration')">
              <span class="material-icons">person_add</span> Register Child
            </button>
            <button class="mui-button secondary" onclick="showSection('register')">
              <span class="material-icons">list_alt</span> View Register
            </button>
            <button class="mui-button" onclick="showSection('defaulters')">
              <span class="material-icons">warning</span> View Defaulters
            </button>
            <button class="mui-button secondary" onclick="showTodayAppointments()">
              <span class="material-icons">today</span> Today's Appointments
            </button>
            <button class="mui-button" onclick="exportDefaultersToPDF()">
              <span class="material-icons">download</span> Download Defaulters PDF
            </button>
            <button class="mui-button secondary" onclick="showSection('reporting')">
              <span class="material-icons">analytics</span> Generate Reports
            </button>
          </div>
        </div>
      </section>

      <section id="registration" style="display: none;">
        <div class="mui-paper">
          <h2 id="registrationTitle">üë∂ Register New Child (0-59 months only)</h2>
          <form id="registerChildForm">
            <input type="hidden" id="childId" value="">
            <div class="filter-grid">
              <div>
                <label>Child's Name *</label>
                <input type="text" id="childName" class="mui-textfield" placeholder="Enter full name" required 
                       onblur="checkForDuplicateChild()">
              </div>
              <div>
                <label>Date of Birth *</label>
                <input type="date" id="childDOB" class="mui-textfield" required max="" 
                       onchange="validateAgeOnRegistration(); checkForDuplicateChild()">
                <small id="ageValidationText" style="color: var(--ghs-gray); font-size: 12px;"></small>
              </div>
              <div>
                <label>Sex *</label>
                <select id="childSex" class="mui-select" required>
                  <option value="">Select</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>
              <div>
                <label>Registration Number</label>
                <input type="text" id="childRegNo" class="mui-textfield" readonly style="background: #f5f5f5; font-weight: bold;">
              </div>
              <div>
                <label>Mother's Name *</label>
                <input type="text" id="motherName" class="mui-textfield" placeholder="Enter mother's name" required 
                       onblur="checkForDuplicateChild()">
              </div>
              <div>
                <label>Telephone No./Traceable Address *</label>
                <input type="text" id="telephoneAddress" class="mui-textfield" placeholder="024XXXXXXX or House No./Street/Landmark" required>
              </div>
              <div>
                <label>Community</label>
                <input type="text" id="childCommunity" class="mui-textfield" placeholder="Enter community">
              </div>
            </div>
            
            <div id="duplicateCheckMessage" style="margin-top: 16px; display: none;"></div>
            <div id="ageValidationMessage" style="margin-top: 16px; display: none;"></div>
            
            <div style="margin-top: 24px;">
              <button type="submit" class="mui-button" id="registerButton">
                <span class="material-icons">save</span> Register Child with Immunization Schedule
              </button>
              <button type="button" class="mui-button secondary" onclick="cancelEdit()" id="cancelEditButton" style="display: none;">
                <span class="material-icons">cancel</span> Cancel Edit
              </button>
              <button type="button" class="mui-button outlined" onclick="showSection('home')" style="margin-left: 10px;">
                <span class="material-icons">arrow_back</span> Back
              </button>
            </div>
          </form>
        </div>
      </section>

      <section id="register" style="display: none;">
        <div class="mui-paper">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2>üìã Child Health Register (0-59 months)</h2>
            <div>
              <input type="text" id="searchChild" class="mui-textfield" placeholder="Search by name, reg no, or phone..." style="width: 300px;" onkeyup="filterChildrenOptimized()">
              <button class="mui-button secondary" onclick="exportChildrenToExcel()" style="margin-left: 10px;">
                <span class="material-icons">download</span> Export Excel
              </button>
              <button class="mui-button" onclick="exportChildrenToPDF()" style="margin-left: 10px;">
                <span class="material-icons">picture_as_pdf</span> Export PDF
              </button>
            </div>
          </div>
          
          <div style="overflow-x: auto;">
            <table class="mui-table" id="childrenTable">
              <thead>
                <tr>
                  <th>Reg No</th>
                  <th>Name</th>
                  <th>Age</th>
                  <th>Mother</th>
                  <th>Telephone/Address</th>
                  <th>Next Visit</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="childrenTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="defaulters" style="display: none;">
        <div class="mui-paper">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2>‚ö†Ô∏è Immunization Defaulters List</h2>
            <div>
              <button class="mui-button secondary" onclick="refreshDefaulters()">
                <span class="material-icons">refresh</span> Refresh
              </button>
              <button class="mui-button" onclick="exportDefaultersToExcel()" style="margin-left: 10px;">
                <span class="material-icons">download</span> Excel
              </button>
              <button class="mui-button" onclick="exportDefaultersToPDF()" style="margin-left: 10px;">
                <span class="material-icons">picture_as_pdf</span> PDF
              </button>
              <button class="mui-button" onclick="exportDefaultersToCSV()" style="margin-left: 10px;">
                <span class="material-icons">table_chart</span> CSV
              </button>
              <button class="mui-button outlined" onclick="clearAllDefaulters()" style="margin-left: 10px;">
                <span class="material-icons">clear_all</span> Clear All
              </button>
            </div>
          </div>
          
          <div class="filter-grid" style="margin-bottom: 20px;">
            <div>
              <label>Default Period</label>
              <select id="defaulterPeriod" class="mui-select" onchange="updateDefaultersListEnhanced()">
                <option value="7">Overdue 7+ days</option>
                <option value="14">Overdue 14+ days</option>
                <option value="30">Overdue 30+ days</option>
                <option value="all">All Defaulters</option>
              </select>
            </div>
            <div>
              <label>Vaccine Type</label>
              <select id="defaulterVaccine" class="mui-select" onchange="updateDefaultersListEnhanced()">
                <option value="all">All Vaccines</option>
                <option value="BCG">BCG</option>
                <option value="OPV">OPV</option>
                <option value="Penta">Penta</option>
                <option value="Measles">Measles Rubella</option>
              </select>
            </div>
            <div>
              <label>Community</label>
              <select id="defaulterCommunity" class="mui-select" onchange="updateDefaultersListEnhanced()">
                <option value="all">All Communities</option>
              </select>
            </div>
          </div>
          
          <div style="background: #fff8e1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffb300;">
            <p style="margin: 0; color: #5d4037; font-size: 14px;">
              <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">info</span>
              <strong>Note:</strong> Defaulters are automatically removed from this list when their immunization schedule is updated.
            </p>
          </div>
          
          <div class="defaulters-table">
            <table class="mui-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Child Name</th>
                  <th>Age</th>
                  <th>Mother</th>
                  <th>Telephone</th>
                  <th>Missed Vaccine(s)</th>
                  <th>Due Date</th>
                  <th>Days Overdue</th>
                  <th>Community</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="defaultersTableBody">
              </tbody>
            </table>
          </div>
          
          <div id="noDefaultersMessage" style="display: none; text-align: center; padding: 40px; color: var(--ghs-gray);">
            <span class="material-icons" style="font-size: 48px; opacity: 0.5;">check_circle</span>
            <p style="margin-top: 16px;">No defaulters found. Great work!</p>
          </div>
        </div>
      </section>

      <section id="dashboard" style="display: none;">
        <div class="mui-paper">
          <h2>üìä Immunization Dashboard</h2>
          
          <div class="stats-container">
            <div class="stat-card">
              <h3>Coverage Rate</h3>
              <div class="stat-value" id="coverageRate">0%</div>
            </div>
            <div class="stat-card">
              <h3>Fully Immunized</h3>
              <div class="stat-value" id="fullyImmunized">0</div>
            </div>
            <div class="stat-card">
              <h3>Dropout Rate</h3>
              <div class="stat-value" id="dropoutRate">0%</div>
            </div>
            <div class="stat-card">
              <h3>Defaulters</h3>
              <div class="stat-value" id="dashboardDefaulters">0</div>
            </div>
          </div>
          
          <div class="chart-grid">
            <div class="chart-container">
              <div class="chart-title">
                <span class="material-icons">pie_chart</span>
                Vaccination Status
              </div>
              <canvas id="vaccinationChart"></canvas>
            </div>
            
            <div class="chart-container">
              <div class="chart-title">
                <span class="material-icons">bar_chart</span>
                Monthly Defaulters
              </div>
              <canvas id="defaultersChart"></canvas>
            </div>
          </div>
          
          <div style="margin-top: 30px;">
            <h3>Recent Immunization Activity</h3>
            <div style="overflow-x: auto; margin-top: 15px;">
              <table class="mui-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Child</th>
                    <th>Vaccine</th>
                    <th>Status</th>
                    <th>Health Worker</th>
                  </tr>
                </thead>
                <tbody id="recentActivityBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="reporting" style="display: none;">
        <div class="mui-paper">
          <h2>üìà Reports & Analytics</h2>
          
          <div class="mui-tabs">
            <button class="mui-tab active" onclick="switchReportTab('summary')">Summary</button>
            <button class="mui-tab" onclick="switchReportTab('detailed')">Detailed</button>
            <button class="mui-tab" onclick="switchReportTab('vaccine')">Vaccine</button>
            <button class="mui-tab" onclick="switchReportTab('defaulters')">Defaulters Report</button>
          </div>
          
          <div id="summaryReport" class="report-content">
            <div class="filter-grid">
              <div>
                <label>Date Range</label>
                <select id="reportPeriod" class="mui-select" onchange="generateEnhancedReport()">
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month" selected>This Month</option>
                  <option value="quarter">This Quarter</option>
                  <option value="year">This Year</option>
                </select>
              </div>
            </div>
            
            <div class="stats-container">
              <div class="stat-card">
                <h3>Total Vaccinations</h3>
                <div class="stat-value" id="reportTotal">0</div>
              </div>
              <div class="stat-card">
                <h3>Average Coverage</h3>
                <div class="stat-value" id="reportCoverage">0%</div>
              </div>
              <div class="stat-card">
                <h3>Defaulters</h3>
                <div class="stat-value" id="reportDefaulters">0</div>
              </div>
              <div class="stat-card">
                <h3>Completion Rate</h3>
                <div class="stat-value" id="reportCompletion">0%</div>
              </div>
            </div>
            
            <div class="chart-grid">
              <div class="chart-container">
                <div class="chart-title">
                  <span class="material-icons">show_chart</span>
                  Vaccination Trend
                </div>
                <canvas id="trendChart"></canvas>
              </div>
              
              <div class="chart-container">
                <div class="chart-title">
                  <span class="material-icons">pie_chart</span>
                  Age Distribution
                </div>
                <canvas id="ageChart"></canvas>
              </div>
            </div>
            
            <div style="margin-top: 24px; display: flex; gap: 12px;">
              <button class="mui-button" onclick="exportToPDF()">
                <span class="material-icons">picture_as_pdf</span> Export PDF
              </button>
              <button class="mui-button secondary" onclick="exportToExcel()">
                <span class="material-icons">table_chart</span> Export Excel
              </button>
              <button class="mui-button" onclick="printReport()">
                <span class="material-icons">print</span> Print Report
              </button>
            </div>
          </div>
          
          <div id="detailedReport" class="report-content" style="display: none;">
            <div style="overflow-x: auto;">
              <table class="mui-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Child Name</th>
                    <th>Vaccine</th>
                    <th>Dose</th>
                    <th>Health Worker</th>
                    <th>Facility</th>
                  </tr>
                </thead>
                <tbody id="detailedReportBody">
                </tbody>
              </table>
            </div>
          </div>
          
          <div id="vaccineReport" class="report-content" style="display: none;">
            <div id="vaccineReportContent">
            </div>
          </div>
          
          <div id="defaultersReport" class="report-content" style="display: none;">
            <div id="defaultersReportContent">
            </div>
          </div>
        </div>
      </section>

      <section id="accountManagement" style="display: none;">
        <div class="account-management">
          <h2>üë§ Account Management</h2>
          
          <div class="account-section">
            <h3>Your Profile</h3>
            <form id="profileForm" class="account-form">
              <div class="form-row">
                <div class="input-group">
                  <label for="profileName">Full Name</label>
                  <input type="text" id="profileName" class="mui-textfield" required>
                </div>
                <div class="input-group">
                  <label for="profileEmail">Email Address</label>
                  <input type="email" id="profileEmail" class="mui-textfield" required readonly style="background: #f5f5f5;">
                </div>
              </div>
              
              <div class="form-row">
                <div class="input-group">
                  <label for="profilePhone">Phone Number</label>
                  <input type="tel" id="profilePhone" class="mui-textfield" placeholder="024XXXXXXX">
                </div>
                <div class="input-group">
                  <label for="profileRole">Role</label>
                  <input type="text" id="profileRole" class="mui-textfield" readonly style="background: #f5f5f5;">
                </div>
              </div>
              
              <div class="form-row">
                <div class="input-group">
                  <label>Account Created</label>
                  <input type="text" id="profileCreated" class="mui-textfield" readonly style="background: #f5f5f5;">
                </div>
                <div class="input-group">
                  <label>Last Login</label>
                  <input type="text" id="profileLastLogin" class="mui-textfield" readonly style="background: #f5f5f5;">
                </div>
              </div>
              
              <button type="submit" class="mui-button" style="width: fit-content;">
                <span class="material-icons">save</span> Update Profile
              </button>
            </form>
          </div>

          <div class="account-section">
            <h3>Change Password</h3>
            <form id="changePasswordForm" class="account-form">
              <div class="form-row">
                <div class="input-group">
                  <label for="currentPassword">Current Password</label>
                  <input type="password" id="currentPassword" class="mui-textfield" required>
                  <div id="currentPasswordError" class="auth-error"></div>
                </div>
              </div>
              
              <div class="form-row">
                <div class="input-group">
                  <label for="newPassword">New Password</label>
                  <input type="password" id="newPassword" class="mui-textfield" required minlength="6">
                  <div class="input-hint">Minimum 6 characters</div>
                  <div id="newPasswordError" class="auth-error"></div>
                  <div class="password-strength">
                    <div id="newPasswordStrengthBar" class="password-strength-bar"></div>
                  </div>
                </div>
                <div class="input-group">
                  <label for="confirmPassword">Confirm New Password</label>
                  <input type="password" id="confirmPassword" class="mui-textfield" required>
                  <div id="confirmPasswordError" class="auth-error"></div>
                </div>
              </div>
              
              <button type="submit" class="mui-button" style="width: fit-content;">
                <span class="material-icons">lock</span> Change Password
              </button>
            </form>
          </div>

          <div id="userManagementSection" class="account-section" style="display: none;">
            <h3>User Management</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0;">
              <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #2e7d32;" id="totalUsersCount">0</div>
                <div style="font-size: 12px; color: #666;">Total Users</div>
              </div>
              <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #1565c0;" id="activeUsersCount">0</div>
                <div style="font-size: 12px; color: #666;">Active Users</div>
              </div>
              <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #ef6c00;" id="adminUsersCount">0</div>
                <div style="font-size: 12px; color: #666;">Administrators</div>
              </div>
              <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #666;" id="todayLoginsCount">0</div>
                <div style="font-size: 12px; color: #666;">Today's Logins</div>
              </div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <button class="mui-button" onclick="showAddUserModal()">
                <span class="material-icons">person_add</span> Add New User
              </button>
            </div>
            
            <div style="overflow-x: auto;">
              <table class="mui-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                </tbody>
              </table>
            </div>
          </div>

          <div class="danger-zone">
            <h4><span class="material-icons">warning</span> Danger Zone</h4>
            <p style="margin-bottom: 16px;">These actions are irreversible. Please proceed with caution.</p>
            
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <button class="mui-button" style="background: var(--ghs-red);" onclick="deleteAccount()">
                <span class="material-icons">delete</span> Delete Account
              </button>
              
              <button class="mui-button outlined" style="border-color: var(--ghs-red); color: var(--ghs-red);" onclick="exportAccountData()">
                <span class="material-icons">download</span> Export Account Data
              </button>
            </div>
          </div>
        </div>
      </section>

      <section id="settings" style="display: none;">
        <div class="mui-paper">
          <h2>‚öôÔ∏è Settings</h2>
          
          <div class="filter-grid">
            <div>
              <label>Facility Name</label>
              <input type="text" id="facilityName" class="mui-textfield" placeholder="Enter facility name">
            </div>
            <div>
              <label>Reminder Days</label>
              <input type="number" id="reminderDays" class="mui-textfield" value="3" min="1" max="7">
            </div>
            <div>
              <label>Language</label>
              <select id="language" class="mui-select">
                <option value="en">English</option>
                <option value="fr">French</option>
              </select>
            </div>
            <div>
              <label>Sync Frequency</label>
              <select id="syncFrequency" class="mui-select">
                <option value="realtime">Real-time</option>
                <option value="hourly">Hourly</option>
                <option value="daily">Daily</option>
              </select>
            </div>
          </div>
          
          <div class="filter-grid" style="margin-top: 20px;">
            <div>
              <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="enableIPV2" onchange="toggleFeatureFlag('ipv2_enabled', this.checked)">
                Enable IPV2 Vaccine (7 Months)
              </label>
              <small style="color: var(--ghs-gray);">Optional inactivated polio vaccine dose</small>
            </div>
            <div>
              <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="enableMalariaVaccine" onchange="toggleFeatureFlag('malaria_vaccine_enabled', this.checked)">
                Enable Malaria Vaccine
              </label>
              <small style="color: var(--ghs-gray);">For high-risk areas only</small>
            </div>
          </div>
          
          <div style="margin-top: 24px; display: flex; flex-wrap: wrap; gap: 12px;">
            <button class="mui-button" onclick="saveSettings()">
              <span class="material-icons">save</span> Save Settings
            </button>
            <button class="mui-button secondary" onclick="exportData()">
              <span class="material-icons">backup</span> Export Data
            </button>
            <button class="mui-button" onclick="clearCache()">
              <span class="material-icons">delete</span> Clear Cache
            </button>
            <button class="mui-button danger" onclick="clearAllData()">
              <span class="material-icons">delete_forever</span> Clear All Data
            </button>
          </div>
          
          <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #e0e0e0;">
            <h3>App Information</h3>
            <p>Version: 5.0.0</p>
            <p>Last Synced: <span id="lastSynced">Never</span></p>
            <p>Data Count: <span id="dataCount">0</span> records</p>
            <p>Storage Used: <span id="storageUsed">0 KB</span></p>
          </div>
        </div>
      </section>
    </div>

    <footer>
      <p>Developed By NASARE SURAJ | Immunization Tracker v5.0 | Ghana Health Service</p>
      <p>2030 EPI Agenda - No Child Left Behind</p>
    </footer>

    <div id="childDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üë∂ Child Details</h2>
          <span class="close" onclick="closeModal('childDetailsModal')">&times;</span>
        </div>
        <div id="childDetailsContent">
        </div>
      </div>
    </div>

    <div id="immunizationScheduleModal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h2>üíâ Immunization Schedule</h2>
          <span class="close" onclick="closeModal('immunizationScheduleModal')">&times;</span>
        </div>
        <div id="immunizationScheduleContent">
        </div>
      </div>
    </div>

    <div id="updateImmunizationModal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h2>üìù Update Immunization</h2>
          <span class="close" onclick="closeModal('updateImmunizationModal')">&times;</span>
        </div>
        <div id="updateImmunizationContent">
        </div>
      </div>
    </div>

    <div id="defaulterDetailsModal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h2>‚ö†Ô∏è Defaulter Details</h2>
          <span class="close" onclick="closeModal('defaulterDetailsModal')">&times;</span>
        </div>
        <div id="defaulterDetailsContent">
        </div>
      </div>
    </div>

    <div id="todayAppointmentsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üìÖ Today's Appointments</h2>
          <span class="close" onclick="closeModal('todayAppointmentsModal')">&times;</span>
        </div>
        <div id="todayAppointmentsContent">
        </div>
      </div>
    </div>

    <div id="addUserModal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h2>üë§ Add New User</h2>
          <span class="close" onclick="closeModal('addUserModal')">&times;</span>
        </div>
        <form id="addUserForm">
          <div class="form-row">
            <div class="input-group">
              <label for="newUserName">Full Name *</label>
              <input type="text" id="newUserName" class="mui-textfield" placeholder="Enter full name" required>
            </div>
            <div class="input-group">
              <label for="newUserEmail">Email Address *</label>
              <input type="email" id="newUserEmail" class="mui-textfield" placeholder="user@example.com" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="input-group">
              <label for="newUserPhone">Phone Number</label>
              <input type="tel" id="newUserPhone" class="mui-textfield" placeholder="024XXXXXXX">
            </div>
            <div class="input-group">
              <label for="newUserRole">Role *</label>
              <select id="newUserRole" class="mui-select" required onchange="togglePermissions()">
                <option value="">Select role</option>
                <option value="admin">Administrator</option>
                <option value="supervisor">Supervisor</option>
                <option value="healthworker">Health Worker</option>
                <option value="dataentry">Data Entry Clerk</option>
                <option value="viewer">Viewer (Read Only)</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="input-group">
              <label for="newUserPassword">Password *</label>
              <input type="password" id="newUserPassword" class="mui-textfield" required minlength="6">
              <div class="input-hint">Minimum 6 characters</div>
              <div class="password-strength">
                <div id="newUserPasswordStrength" class="password-strength-bar"></div>
              </div>
            </div>
            <div class="input-group">
              <label for="newUserConfirmPassword">Confirm Password *</label>
              <input type="password" id="newUserConfirmPassword" class="mui-textfield" required>
            </div>
          </div>
          
          <div class="input-group">
            <label>Permissions</label>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 8px;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="permRegister" checked> Register Children
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="permVaccinate" checked> Record Vaccinations
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="permView" checked> View Records
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="permEdit" checked> Edit Records
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="permDelete"> Delete Records
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="permReports"> Generate Reports
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="permExport"> Export Data
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="permManage" disabled> Manage Users
              </label>
            </div>
          </div>
          
          <div class="input-group" style="margin-top: 15px;">
            <label for="newUserNotes">Notes/Remarks</label>
            <textarea id="newUserNotes" class="mui-textfield" rows="3" placeholder="Any additional information about this user..."></textarea>
          </div>
          
          <div style="margin-top: 24px; display: flex; gap: 12px;">
            <button type="submit" class="mui-button">
              <span class="material-icons">person_add</span> Create User Account
            </button>
            <button type="button" class="mui-button secondary" onclick="closeModal('addUserModal')">
              <span class="material-icons">cancel</span> Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="editUserModal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h2>‚úèÔ∏è Edit User</h2>
          <span class="close" onclick="closeModal('editUserModal')">&times;</span>
        </div>
        <form id="editUserForm">
          <input type="hidden" id="editUserId">
          
          <div class="form-row">
            <div class="input-group">
              <label for="editUserName">Full Name *</label>
              <input type="text" id="editUserName" class="mui-textfield" required>
            </div>
            <div class="input-group">
              <label for="editUserEmail">Email Address *</label>
              <input type="email" id="editUserEmail" class="mui-textfield" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="input-group">
              <label for="editUserPhone">Phone Number</label>
              <input type="tel" id="editUserPhone" class="mui-textfield">
            </div>
            <div class="input-group">
              <label for="editUserRole">Role *</label>
              <select id="editUserRole" class="mui-select" required onchange="toggleEditPermissions()">
                <option value="">Select role</option>
                <option value="admin">Administrator</option>
                <option value="supervisor">Supervisor</option>
                <option value="healthworker">Health Worker</option>
                <option value="dataentry">Data Entry Clerk</option>
                <option value="viewer">Viewer (Read Only)</option>
              </select>
            </div>
          </div>
          
          <div class="input-group">
            <label>Permissions</label>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 8px;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="editPermRegister"> Register Children
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="editPermVaccinate"> Record Vaccinations
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="editPermView"> View Records
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="editPermEdit"> Edit Records
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="editPermDelete"> Delete Records
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="editPermReports"> Generate Reports
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="editPermExport"> Export Data
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="editPermManage" disabled> Manage Users
              </label>
            </div>
          </div>
          
          <div class="input-group" style="margin-top: 15px;">
            <label for="editUserNotes">Notes/Remarks</label>
            <textarea id="editUserNotes" class="mui-textfield" rows="3"></textarea>
          </div>
          
          <div style="margin-top: 24px; display: flex; gap: 12px;">
            <button type="submit" class="mui-button">
              <span class="material-icons">save</span> Update User
            </button>
            <button type="button" class="mui-button secondary" onclick="closeModal('editUserModal')">
              <span class="material-icons">cancel</span> Cancel
            </button>
            <button type="button" class="mui-button danger" onclick="resetUserPasswordPrompt()" style="margin-left: auto;">
              <span class="material-icons">lock_reset</span> Reset Password
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="clearDataModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h2>‚ö†Ô∏è Clear All Data</h2>
          <span class="close" onclick="closeModal('clearDataModal')">&times;</span>
        </div>
        <div id="clearDataContent">
          <div style="text-align: center; padding: 20px;">
            <span class="material-icons" style="font-size: 64px; color: var(--ghs-red); margin-bottom: 20px;">warning</span>
            <h3 style="color: var(--ghs-red); margin-bottom: 15px;">Danger: Irreversible Action</h3>
            <p style="margin-bottom: 20px; color: var(--ghs-dark);">
              This will delete <strong>ALL</strong> children data from your facility. 
              This action cannot be undone.
            </p>
            <p style="margin-bottom: 25px; color: var(--ghs-gray); font-size: 14px;">
              All children records, immunization schedules, and vaccination history will be permanently deleted.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center;">
              <button class="mui-button danger" onclick="confirmClearAllData()" style="padding: 12px 24px;">
                <span class="material-icons">delete_forever</span> Delete All Data
              </button>
              <button class="mui-button secondary" onclick="closeModal('clearDataModal')" style="padding: 12px 24px;">
                <span class="material-icons">cancel</span> Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="loadingIndicator" class="loading" style="display: none;">
    <div class="spinner"></div>
    <p id="loadingMessage">Loading...</p>
  </div>

  <div id="notificationArea"></div>

  <button id="installPWAButton" class="mui-button" style="display: none;">
    <span class="material-icons">download</span> Install App
  </button>

  <script>
    const optionalVaccines = {
      IPV2: {
        name: "IPV2",
        dose: "7 Months",
        ageDays: 210,
        category: "7months",
        isOptional: true,
        enabled: true
      },
      MalariaVaccine: {
        name: "Malaria Vaccine",
        dose: "6-12 Months",
        ageDays: 180,
        category: "malaria",
        isOptional: true,
        enabled: false,
        requiresApproval: true
      }
    };

    let currentUser = null;
    let currentFacility = null;
    let appData = {
      children: [],
      settings: {},
      lastSync: null,
      users: [],
      defaulters: []
    };

    let auth = null;
    let db = null;
    let firestore = null;
    let firestoreUnsubscribe = null;

    let statsCache = {
      timestamp: null,
      data: null,
      cacheDuration: 5 * 60 * 1000
    };

    let searchTimeout;
    let deferredPrompt;

    const vaccineSchedule = [
      { name: "BCG", dose: "Birth", ageDays: 0, category: "birth" },
      { name: "OPV0", dose: "Birth", ageDays: 0, category: "birth" },
      { name: "Hepatitis B", dose: "Birth", ageDays: 0, category: "birth" },
      { name: "OPV1", dose: "6 Weeks", ageDays: 42, category: "6weeks" },
      { name: "Penta1", dose: "6 Weeks", ageDays: 42, category: "6weeks" },
      { name: "PCV1", dose: "6 Weeks", ageDays: 42, category: "6weeks" },
      { name: "Rotavirus1", dose: "6 Weeks", ageDays: 42, category: "6weeks" },
      { name: "OPV2", dose: "10 Weeks", ageDays: 70, category: "10weeks" },
      { name: "Penta2", dose: "10 Weeks", ageDays: 70, category: "10weeks" },
      { name: "PCV2", dose: "10 Weeks", ageDays: 70, category: "10weeks" },
      { name: "Rotavirus2", dose: "10 Weeks", ageDays: 70, category: "10weeks" },
      { name: "OPV3", dose: "14 Weeks", ageDays: 98, category: "14weeks" },
      { name: "Penta3", dose: "14 Weeks", ageDays: 98, category: "14weeks" },
      { name: "PCV3", dose: "14 Weeks", ageDays: 98, category: "14weeks" },
      { name: "Rotavirus3", dose: "14 Weeks", ageDays: 98, category: "14weeks" },
      { name: "IPV1", dose: "14 Weeks", ageDays: 98, category: "14weeks" },
      { name: "Malaria1", dose: "6 Months", ageDays: 180, category: "6months" },
      { name: "Vitamin A1", dose: "6 Months", ageDays: 180, category: "vitaminA" },
      { name: "Malaria2", dose: "7 Months", ageDays: 210, category: "7months" },
      { name: "Malaria3", dose: "9 Months", ageDays: 270, category: "9months" },
      { name: "Measles Rubella1", dose: "9 Months", ageDays: 270, category: "9months" },
      { name: "Vitamin A2", dose: "12 Months", ageDays: 365, category: "vitaminA" },
      { name: "Malaria4", dose: "18 Months", ageDays: 540, category: "18months" },
      { name: "Measles Rubella2", dose: "18 Months", ageDays: 540, category: "18months" },
      { name: "Men A", dose: "18 Months", ageDays: 540, category: "18months" },
      { name: "LLIN", dose: "18 Months", ageDays: 540, category: "18months" },
      { name: "Vitamin A3", dose: "18 Months", ageDays: 540, category: "vitaminA" },
      { name: "Vitamin A4", dose: "24 Months", ageDays: 730, category: "vitaminA" },
      { name: "Vitamin A5", dose: "30 Months", ageDays: 913, category: "vitaminA" },
      { name: "Vitamin A6", dose: "36 Months", ageDays: 1095, category: "vitaminA" },
      { name: "Vitamin A7", dose: "42 Months", ageDays: 1278, category: "vitaminA" },
      { name: "Vitamin A8", dose: "48 Months", ageDays: 1460, category: "vitaminA" },
      { name: "Vitamin A9", dose: "54 Months", ageDays: 1643, category: "vitaminA" },
      { name: "Vitamin A10", dose: "60 Months", ageDays: 1825, category: "vitaminA" }
    ];

    document.addEventListener('DOMContentLoaded', async function() {
      setupEventListeners();
      checkOnlineStatus();
      
      if (window.firebase) {
        auth = window.firebase.auth.getAuth();
        db = window.firebase.firestore.getFirestore();
        firestore = window.firebase.firestore;
        
        window.firebase.auth.onAuthStateChanged(auth, async (user) => {
          if (user) {
            await handleLoginSuccess(user);
          } else {
            document.getElementById('appScreen').style.display = 'none';
            document.getElementById('authScreen').style.display = 'flex';
            showLogin();
          }
        });
        
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
          const userData = JSON.parse(savedUser);
          try {
            await window.firebase.auth.signInWithEmailAndPassword(auth, userData.email, userData.password);
          } catch (error) {
            localStorage.removeItem('currentUser');
            showNotification('Session expired. Please login again.', 'warning');
          }
        }
      } else {
        showNotification('Firebase initialization failed. Please refresh.', 'error');
      }
      
      window.addEventListener('online', checkOnlineStatus);
      window.addEventListener('offline', checkOnlineStatus);
      
      initializePWA();
      
      const today = new Date();
      const maxDate = today.toISOString().split('T')[0];
      const childDOB = document.getElementById('childDOB');
      if (childDOB) {
        childDOB.max = maxDate;
        const defaultDOB = new Date();
        defaultDOB.setFullYear(defaultDOB.getFullYear() - 1);
        childDOB.value = defaultDOB.toISOString().split('T')[0];
        validateAgeOnRegistration();
      }
      
      const vaccineDate = document.getElementById('vaccineDate');
      if (vaccineDate) {
        vaccineDate.valueAsDate = today;
      }
      
      setInterval(checkAndUpdateAgeStatus, 3600000);
      setTimeout(checkAndUpdateAgeStatus, 5000);
      setTimeout(initializeEnhancedSettings, 1000);
      setTimeout(loadFeatureFlags, 1500);
      
      setTimeout(() => {
        const pdfExportButton = document.querySelector('button[onclick="exportToPDF()"]');
        if (pdfExportButton) {
          pdfExportButton.onclick = exportToPDF;
        }
      }, 2000);
    });

    function setupEventListeners() {
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('signupForm').addEventListener('submit', handleSignup);
      document.getElementById('forgotPasswordForm').addEventListener('submit', handleResetPassword);
      document.getElementById('profileForm')?.addEventListener('submit', handleProfileUpdate);
      document.getElementById('changePasswordForm')?.addEventListener('submit', handleChangePassword);
      document.getElementById('addUserForm')?.addEventListener('submit', handleAddUser);
      document.getElementById('editUserForm')?.addEventListener('submit', handleEditUser);
      
      const registerForm = document.getElementById('registerChildForm');
      if (registerForm) {
        registerForm.addEventListener('submit', handleRegisterChild);
      }
      
      document.getElementById('childName')?.addEventListener('blur', checkForDuplicateChild);
      document.getElementById('motherName')?.addEventListener('blur', checkForDuplicateChild);
      document.getElementById('childDOB')?.addEventListener('change', () => {
        validateAgeOnRegistration();
        checkForDuplicateChild();
      });
      
      const signupPassword = document.getElementById('signupPassword');
      const newPassword = document.getElementById('newPassword');
      const newUserPassword = document.getElementById('newUserPassword');
      
      if (signupPassword) {
        signupPassword.addEventListener('input', function() {
          checkPasswordStrength(this.value, 'passwordStrengthBar');
        });
      }
      
      if (newPassword) {
        newPassword.addEventListener('input', function() {
          checkPasswordStrength(this.value, 'newPasswordStrengthBar');
        });
      }
      
      if (newUserPassword) {
        newUserPassword.addEventListener('input', function() {
          checkPasswordStrength(this.value, 'newUserPasswordStrength');
        });
      }
      
      document.getElementById('installPWAButton').addEventListener('click', installPWA);
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      clearAuthErrors();
      
      if (!email || !password) {
        showAuthError('loginEmailError', 'Please enter both email and password');
        return;
      }
      
      try {
        showLoading('Logging in...');
        const userCredential = await window.firebase.auth.signInWithEmailAndPassword(auth, email, password);
        localStorage.setItem('currentUser', JSON.stringify({
          email: email,
          password: password,
          remember: true
        }));
      } catch (error) {
        let errorMessage = 'Login failed. Please check your credentials.';
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email.';
            break;
          case 'auth/wrong-password':
            errorMessage = 'Incorrect password. Please try again.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address.';
            break;
          case 'auth/user-disabled':
            errorMessage = 'This account has been disabled.';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Too many failed attempts. Please try again later.';
            break;
        }
        showAuthError('loginPasswordError', errorMessage);
        hideLoading();
      }
    }

    async function handleLoginSuccess(user) {
      try {
        showLoading('Loading your data...');
        const userRef = firestore.doc(db, `users/${user.uid}`);
        const userDoc = await firestore.getDoc(userRef);
        
        if (!userDoc.exists()) {
          await firestore.setDoc(userRef, {
            email: user.email,
            name: user.displayName || user.email.split('@')[0],
            createdAt: firestore.serverTimestamp(),
            lastLogin: firestore.serverTimestamp(),
            role: 'admin',
            status: 'active'
          });
          currentUser = {
            uid: user.uid,
            email: user.email,
            name: user.email.split('@')[0],
            role: 'admin',
            status: 'active'
          };
        } else {
          const userData = userDoc.data();
          currentUser = {
            uid: user.uid,
            email: user.email,
            name: userData.name || user.email.split('@')[0],
            role: userData.role || 'user',
            status: userData.status || 'active',
            phone: userData.phone || '',
            createdAt: userData.createdAt?.toDate() || new Date(),
            lastLogin: userData.lastLogin?.toDate() || new Date()
          };
          await firestore.updateDoc(userRef, {
            lastLogin: firestore.serverTimestamp()
          });
          
          if (userData.facilityId) {
            const facilityRef = firestore.doc(db, `facilities/${userData.facilityId}`);
            const facilityDoc = await firestore.getDoc(facilityRef);
            if (facilityDoc.exists()) {
              currentFacility = {
                id: facilityDoc.id,
                ...facilityDoc.data()
              };
            }
          } else if (userData.role === 'admin') {
            currentFacility = await createDefaultFacility(user.uid, user.email.split('@')[0]);
          }
        }
        
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('appScreen').style.display = 'block';
        updateUserInterface();
        await loadUserData();
        showNotification(`Welcome back, ${currentUser.name}!`, 'success');
      } catch (error) {
        showNotification('Error loading user data. Please try again.', 'error');
        await logout();
      } finally {
        hideLoading();
      }
    }

    async function createDefaultFacility(uid, userName) {
      try {
        const facilityData = {
          name: `${userName}'s Health Facility`,
          createdBy: uid,
          createdAt: firestore.serverTimestamp(),
          registrationCounter: {
            year: new Date().getFullYear().toString().slice(-2),
            sequence: 0
          },
          settings: {
            reminderDays: 3,
            language: 'en',
            syncFrequency: 'realtime'
          }
        };
        const facilityRef = firestore.collection(db, 'facilities');
        const docRef = await firestore.addDoc(facilityRef, facilityData);
        const userRef = firestore.doc(db, `users/${uid}`);
        await firestore.updateDoc(userRef, {
          facilityId: docRef.id
        });
        const counterRef = firestore.doc(db, `facilities/${docRef.id}/counters/registration`);
        await firestore.setDoc(counterRef, {
          year: new Date().getFullYear().toString().slice(-2),
          sequence: 0,
          updatedAt: firestore.serverTimestamp()
        });
        return {
          id: docRef.id,
          ...facilityData
        };
      } catch (error) {
        return null;
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      const name = document.getElementById('signupName').value;
      const facilityName = document.getElementById('signupFacility').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('signupConfirmPassword').value;
      
      clearAuthErrors();
      
      if (!name || !facilityName || !email || !password || !confirmPassword) {
        showAuthError('signupNameError', 'Please fill in all fields');
        return;
      }
      
      if (password !== confirmPassword) {
        showAuthError('signupConfirmPasswordError', 'Passwords do not match');
        return;
      }
      
      if (password.length < 6) {
        showAuthError('signupPasswordError', 'Password must be at least 6 characters');
        return;
      }
      
      try {
        showLoading('Creating your facility account...');
        const userCredential = await window.firebase.auth.createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const facilityData = {
          name: facilityName,
          createdBy: user.uid,
          createdAt: firestore.serverTimestamp(),
          registrationCounter: {
            year: new Date().getFullYear().toString().slice(-2),
            sequence: 0
          },
          settings: {
            reminderDays: 3,
            language: 'en',
            syncFrequency: 'realtime'
          }
        };
        const facilityRef = firestore.collection(db, 'facilities');
        const facilityDoc = await firestore.addDoc(facilityRef, facilityData);
        const userRef = firestore.doc(db, `users/${user.uid}`);
        await firestore.setDoc(userRef, {
          name: name,
          email: email,
          facilityId: facilityDoc.id,
          role: 'admin',
          status: 'active',
          createdAt: firestore.serverTimestamp(),
          lastLogin: firestore.serverTimestamp()
        });
        const counterRef = firestore.doc(db, `facilities/${facilityDoc.id}/counters/registration`);
        await firestore.setDoc(counterRef, {
          year: new Date().getFullYear().toString().slice(-2),
          sequence: 0,
          updatedAt: firestore.serverTimestamp()
        });
        localStorage.setItem('currentUser', JSON.stringify({
          email: email,
          password: password,
          remember: true
        }));
        showNotification('Facility account created successfully!', 'success');
      } catch (error) {
        let errorMessage = 'Signup failed. Please try again.';
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMessage = 'This email is already registered.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address.';
            break;
          case 'auth/weak-password':
            errorMessage = 'Password is too weak. Please choose a stronger password.';
            break;
          case 'auth/operation-not-allowed':
            errorMessage = 'Email/password accounts are not enabled.';
            break;
        }
        showAuthError('signupEmailError', errorMessage);
        hideLoading();
      }
    }

    async function handleResetPassword(e) {
      e.preventDefault();
      const email = document.getElementById('resetEmail').value;
      if (!email) {
        showAuthError('resetEmailError', 'Please enter your email address');
        return;
      }
      try {
        showLoading('Sending reset email...');
        await window.firebase.auth.sendPasswordResetEmail(auth, email);
        showNotification('Password reset email sent! Check your inbox.', 'success');
        showLogin();
      } catch (error) {
        let errorMessage = 'Failed to send reset email.';
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address.';
            break;
        }
        showAuthError('resetEmailError', errorMessage);
      } finally {
        hideLoading();
      }
    }

    async function logout() {
      try {
        if (firestoreUnsubscribe) {
          firestoreUnsubscribe();
          firestoreUnsubscribe = null;
        }
        await window.firebase.auth.signOut(auth);
        currentUser = null;
        currentFacility = null;
        appData = {
          children: [],
          settings: {},
          lastSync: null,
          users: [],
          defaulters: []
        };
        localStorage.removeItem('currentUser');
        document.getElementById('appScreen').style.display = 'none';
        document.getElementById('authScreen').style.display = 'flex';
        clearAuthForms();
        showLogin();
        showNotification('Logged out successfully', 'success');
      } catch (error) {
        showNotification('Logout failed: ' + error.message, 'error');
      }
    }

    async function loadUserData() {
      if (!currentUser || !currentFacility) return;
      
      try {
        showLoading('Loading data...');
        const childrenRef = firestore.collection(db, 'child_health_register');
        const q = firestore.query(
          childrenRef,
          firestore.where('facilityId', '==', currentFacility.id)
        );
        
        const querySnapshot = await firestore.getDocs(q);
        appData.children = [];
        
        querySnapshot.forEach((doc) => {
          const childData = doc.data();
          appData.children.push({
            id: doc.id,
            collection: 'child_health_register',
            ...childData,
            createdAt: childData.createdAt?.toDate?.() || new Date(),
            dob: childData.dob || null,
            nextVisit: childData.nextVisit || null,
            regNo: childData.regNo || childData.registrationNumber || 'N/A',
            motherName: childData.motherName || childData.mother || 'N/A',
            telephoneAddress: childData.telephoneAddress || childData.phone || childData.address || 'N/A',
            community: childData.community || childData.location || 'N/A',
            vaccinations: childData.vaccinations || [],
            immunizationSchedule: childData.immunizationSchedule || generateImmunizationSchedule(childData.dob),
            isDefaulter: childData.isDefaulter || false,
            ageInMonths: childData.ageInMonths || calculateAgeInMonths(childData.dob)
          });
        });
        
        updateDefaultersListEnhanced();
        await loadUsers();
        updateStats();
        updateChildrenTable();
        updateAccountProfile();
        appData.lastSync = new Date();
        document.getElementById('lastSynced').textContent = appData.lastSync.toLocaleTimeString();
        document.getElementById('dataCount').textContent = appData.children.length;
        await generateNextRegistrationNumber();
        setupRealtimeListener();
      } catch (error) {
        showNotification('Error loading data: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function loadUsers() {
      try {
        const usersRef = firestore.collection(db, 'users');
        const q = firestore.query(
          usersRef,
          firestore.where('facilityId', '==', currentFacility.id)
        );
        const querySnapshot = await firestore.getDocs(q);
        appData.users = [];
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          appData.users.push({
            id: doc.id,
            ...userData,
            createdAt: userData.createdAt?.toDate() || new Date(),
            lastLogin: userData.lastLogin?.toDate() || null
          });
        });
        updateUsersTable();
        updateUserStatistics();
        const userManagementSection = document.getElementById('userManagementSection');
        if (userManagementSection) {
          userManagementSection.style.display = currentUser.role === 'admin' ? 'block' : 'none';
        }
      } catch (error) {}
    }

    async function generateNextRegistrationNumber() {
      if (!currentUser || !currentFacility) return;
      try {
        const counterRef = firestore.doc(db, `facilities/${currentFacility.id}/counters/registration`);
        const counterDoc = await firestore.getDoc(counterRef);
        let currentYear = new Date().getFullYear().toString().slice(-2);
        let sequence = 1;
        if (counterDoc.exists()) {
          const data = counterDoc.data();
          if (data.year !== currentYear) {
            sequence = 1;
          } else {
            sequence = data.sequence + 1;
          }
        }
        const regNo = `CHN${sequence.toString().padStart(3, '0')}/${currentYear}`;
        const regNoInput = document.getElementById('childRegNo');
        if (regNoInput) {
          regNoInput.value = regNo;
        }
      } catch (error) {
        const currentYear = new Date().getFullYear().toString().slice(-2);
        const regNo = `CHN001/${currentYear}`;
        const regNoInput = document.getElementById('childRegNo');
        if (regNoInput) {
          regNoInput.value = regNo;
        }
      }
    }

    function setupRealtimeListener() {
      if (!currentUser || !currentFacility) return;
      if (firestoreUnsubscribe) {
        firestoreUnsubscribe();
      }
      try {
        const childrenRef = firestore.collection(db, 'child_health_register');
        const q = firestore.query(
          childrenRef,
          firestore.where('facilityId', '==', currentFacility.id)
        );
        firestoreUnsubscribe = firestore.onSnapshot(q, (snapshot) => {
          const updatedChildren = [];
          const processedIds = new Set();
          
          snapshot.docChanges().forEach((change) => {
            const childData = change.doc.data();
            const childId = change.doc.id;
            
            if (!processedIds.has(childId)) {
              processedIds.add(childId);
              
              updatedChildren.push({
                id: childId,
                ...childData,
                dob: childData.dob || null,
                nextVisit: childData.nextVisit || null,
                regNo: childData.regNo || 'N/A',
                motherName: childData.motherName || 'N/A',
                telephoneAddress: childData.telephoneAddress || 'N/A',
                community: childData.community || 'N/A',
                vaccinations: childData.vaccinations || [],
                immunizationSchedule: childData.immunizationSchedule || generateImmunizationSchedule(childData.dob),
                isDefaulter: childData.isDefaulter || false,
                ageInMonths: childData.ageInMonths || calculateAgeInMonths(childData.dob)
              });
            }
          });
          
          appData.children = updatedChildren;
          updateChildrenTable();
          updateDefaultersListEnhanced();
          updateStats();
          appData.lastSync = new Date();
          document.getElementById('lastSynced').textContent = appData.lastSync.toLocaleTimeString();
          document.getElementById('dataCount').textContent = appData.children.length;
          
        }, (error) => {
          showNotification('Error receiving real-time updates. Please refresh.', 'warning');
        });
      } catch (error) {}
    }

    function validateChildAge(dob) {
      if (!dob) return { valid: false, message: "Date of birth is required" };
      const birthDate = new Date(dob);
      const today = new Date();
      if (birthDate > today) {
        return { valid: false, message: "Date of birth cannot be in the future" };
      }
      const ageInMonths = (today.getFullYear() - birthDate.getFullYear()) * 12 + 
                         (today.getMonth() - birthDate.getMonth());
      if (today.getDate() < birthDate.getDate()) {
        ageInMonths--;
      }
      if (ageInMonths < 0) {
        return { valid: false, message: "Date of birth cannot be in the future" };
      }
      if (ageInMonths >= 60) {
        return { 
          valid: false, 
          message: "Child is 5 years or older (60+ months). System is for children 0-59 months only." 
        };
      }
      return { valid: true, ageInMonths };
    }

    async function checkForDuplicateChild() {
      const childName = document.getElementById('childName')?.value?.toLowerCase().trim();
      const motherName = document.getElementById('motherName')?.value?.toLowerCase().trim();
      const childDOB = document.getElementById('childDOB')?.value;
      
      if (!childName || !motherName || !childDOB) {
        return;
      }
      
      try {
        const messageDiv = document.getElementById('duplicateCheckMessage');
        const registerButton = document.getElementById('registerButton');
        
        const ageValidation = validateChildAge(childDOB);
        if (!ageValidation.valid) {
          messageDiv.innerHTML = `
            <div style="background: #fff3e0; color: #ef6c00; padding: 12px; border-radius: 6px; border-left: 4px solid #ef6c00;">
              <strong>‚ö†Ô∏è Age Validation Failed:</strong> ${ageValidation.message}
            </div>
          `;
          messageDiv.style.display = 'block';
          registerButton.disabled = true;
          return;
        }
        
        const existingChild = await checkForDuplicateInFirestore(childName, motherName, childDOB);
        
        if (existingChild.exists) {
          messageDiv.innerHTML = `
            <div style="background: #ffebee; color: #c62828; padding: 12px; border-radius: 6px; border-left: 4px solid #c62828;">
              <strong>‚ö†Ô∏è Child Already Registered:</strong> This child is already registered 
              (Reg No: ${existingChild.data.regNo || 'N/A'}, Name: ${existingChild.data.name})
            </div>
          `;
          messageDiv.style.display = 'block';
          registerButton.disabled = true;
          registerButton.style.opacity = '0.6';
          registerButton.style.cursor = 'not-allowed';
          
          if (!document.getElementById('editChildButton')) {
            const editButton = document.createElement('button');
            editButton.id = 'editChildButton';
            editButton.className = 'mui-button secondary';
            editButton.style.marginTop = '10px';
            editButton.innerHTML = '<span class="material-icons">edit</span> Edit Child';
            editButton.onclick = () => loadChildForEdit(existingChild.id);
            messageDiv.appendChild(editButton);
          }
        } else {
          messageDiv.style.display = 'none';
          registerButton.disabled = false;
          registerButton.style.opacity = '1';
          registerButton.style.cursor = 'pointer';
          const editButton = document.getElementById('editChildButton');
          if (editButton) editButton.remove();
        }
      } catch (error) {}
    }

    async function checkForDuplicateInFirestore(childName, motherName, dob) {
      try {
        const childrenRef = firestore.collection(db, 'child_health_register');
        const nameQuery = firestore.query(
          childrenRef,
          firestore.where('name', '==', childName),
          firestore.where('motherName', '==', motherName),
          firestore.where('dob', '==', dob),
          firestore.where('facilityId', '==', currentFacility.id)
        );
        const querySnapshot = await firestore.getDocs(nameQuery);
        if (!querySnapshot.empty) {
          const duplicateDoc = querySnapshot.docs[0];
          return {
            exists: true,
            id: duplicateDoc.id,
            data: duplicateDoc.data()
          };
        }
        return { exists: false };
      } catch (error) {
        return { exists: false, error: error.message };
      }
    }

    function validateAgeOnRegistration() {
      const dobInput = document.getElementById('childDOB');
      const ageValidationText = document.getElementById('ageValidationText');
      const ageValidationMessage = document.getElementById('ageValidationMessage');
      const registerButton = document.getElementById('registerButton');
      
      if (!dobInput.value) {
        ageValidationText.textContent = '';
        ageValidationMessage.style.display = 'none';
        return;
      }
      
      const ageValidation = validateChildAge(dobInput.value);
      
      if (!ageValidation.valid) {
        ageValidationText.textContent = `‚ùå ${ageValidation.message}`;
        ageValidationText.style.color = 'var(--ghs-red)';
        ageValidationMessage.innerHTML = `
          <div style="background: #ffebee; color: #c62828; padding: 12px; border-radius: 6px; border-left: 4px solid #c62828;">
            <strong>‚ö†Ô∏è Age Restriction:</strong> ${ageValidation.message}
          </div>
        `;
        ageValidationMessage.style.display = 'block';
        registerButton.disabled = true;
      } else {
        ageValidationText.textContent = `‚úÖ Child age: ${ageValidation.ageInMonths} months`;
        ageValidationText.style.color = 'var(--ghs-green)';
        ageValidationMessage.style.display = 'none';
        registerButton.disabled = false;
      }
    }

    async function handleRegisterChild(e) {
      e.preventDefault();
      const registerButton = document.getElementById('registerButton');
      const originalButtonText = registerButton.innerHTML;
      registerButton.disabled = true;
      registerButton.innerHTML = '<span class="material-icons">hourglass_empty</span> Processing...';
      registerButton.style.opacity = '0.6';
      registerButton.style.cursor = 'not-allowed';
      
      if (!currentUser || !currentFacility) {
        reEnableButton(registerButton, originalButtonText);
        showNotification('User not authenticated. Please login again.', 'error');
        return;
      }
      
      const childName = document.getElementById('childName').value.trim();
      const childDOB = document.getElementById('childDOB').value;
      const childSex = document.getElementById('childSex').value;
      const motherName = document.getElementById('motherName').value.trim();
      const telephoneAddress = document.getElementById('telephoneAddress').value.trim();
      const childCommunity = document.getElementById('childCommunity').value.trim();
      const regNo = document.getElementById('childRegNo').value;
      
      if (!childName || !childDOB || !childSex || !motherName || !telephoneAddress) {
        showNotification('Please fill in all required fields marked with *.', 'error');
        reEnableButton(registerButton, originalButtonText);
        return;
      }
      
      const ageValidation = validateChildAge(childDOB);
      if (!ageValidation.valid) {
        showNotification(ageValidation.message, 'error');
        reEnableButton(registerButton, originalButtonText);
        return;
      }
      
      try {
        showLoading('Registering child...');
        const duplicateCheck = await checkForDuplicateInFirestore(childName, motherName, childDOB);
        if (duplicateCheck.exists) {
          showNotification(`Child already registered with ID: ${duplicateCheck.id}`, 'error');
          reEnableButton(registerButton, originalButtonText);
          hideLoading();
          return;
        }
        
        const childId = `child_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const immunizationSchedule = generateImmunizationSchedule(childDOB);
        const pendingVaccines = immunizationSchedule.filter(v => v.status === 'pending');
        let nextVisit = null;
        if (pendingVaccines.length > 0) {
          const earliestPending = pendingVaccines.reduce((earliest, current) => {
            const currentDate = new Date(current.dueDate);
            const earliestDate = earliest ? new Date(earliest.dueDate) : new Date('9999-12-31');
            return currentDate < earliestDate ? current : earliest;
          });
          nextVisit = earliestPending.dueDate;
        }
        
        const childData = {
          name: childName,
          dob: childDOB,
          sex: childSex,
          regNo: regNo,
          motherName: motherName,
          telephoneAddress: telephoneAddress,
          community: childCommunity || '',
          facilityId: currentFacility.id,
          registeredBy: currentUser.uid,
          status: 'active',
          vaccinations: [],
          immunizationSchedule: immunizationSchedule,
          nextVisit: nextVisit,
          ageInMonths: ageValidation.ageInMonths,
          isDefaulter: false,
          lastDefaulterCheck: firestore.Timestamp.now(),
          createdAt: firestore.Timestamp.now(),
          updatedAt: firestore.Timestamp.now()
        };
        
        const childRef = firestore.doc(db, `child_health_register/${childId}`);
        await firestore.setDoc(childRef, childData);
        
        const counterRef = firestore.doc(db, `facilities/${currentFacility.id}/counters/registration`);
        await firestore.updateDoc(counterRef, {
          sequence: firestore.increment(1),
          updatedAt: firestore.Timestamp.now()
        });
        
        document.getElementById('registerChildForm').reset();
        document.getElementById('duplicateCheckMessage').style.display = 'none';
        document.getElementById('ageValidationMessage').style.display = 'none';
        await generateNextRegistrationNumber();
        showNotification('Child registered successfully with immunization schedule!', 'success');
        setTimeout(() => showSection('home'), 1000);
      } catch (error) {
        let errorMessage = 'Failed to register child: ' + error.message;
        if (error.code === 'permission-denied') {
          errorMessage = 'Permission denied. You may not have write access.';
        } else if (error.code === 'not-found') {
          errorMessage = 'Database not found. Please try again.';
        } else if (error.code === 'already-exists') {
          errorMessage = 'Child already exists in the database.';
        }
        showNotification(errorMessage, 'error');
      } finally {
        hideLoading();
        reEnableButton(registerButton, originalButtonText);
      }
    }

    function loadChildForEdit(childId) {
      const child = appData.children.find(c => c.id === childId);
      if (!child) {
        showNotification('Child not found.', 'error');
        return;
      }
      document.getElementById('childId').value = childId;
      document.getElementById('childName').value = child.name || '';
      document.getElementById('childDOB').value = child.dob || '';
      document.getElementById('childSex').value = child.sex || '';
      document.getElementById('childRegNo').value = child.regNo || '';
      document.getElementById('motherName').value = child.motherName || '';
      document.getElementById('telephoneAddress').value = child.telephoneAddress || '';
      document.getElementById('childCommunity').value = child.community || '';
      document.getElementById('registrationTitle').textContent = '‚úèÔ∏è Edit Child Details';
      document.getElementById('registerButton').innerHTML = '<span class="material-icons">save</span> Update Child Details';
      document.getElementById('cancelEditButton').style.display = 'inline-block';
      showSection('registration');
      validateAgeOnRegistration();
      showNotification('Child loaded for editing. Make changes and click "Update Child Details".', 'info');
    }

    function reEnableButton(button, originalHtml) {
      button.disabled = false;
      button.innerHTML = originalHtml;
      button.style.opacity = '1';
      button.style.cursor = 'pointer';
    }

    function generateImmunizationSchedule(dob) {
      const birthDate = new Date(dob);
      const schedule = [];
      vaccineSchedule.forEach(vaccine => {
        const dueDate = new Date(birthDate);
        dueDate.setDate(dueDate.getDate() + vaccine.ageDays);
        schedule.push({
          vaccine: vaccine.name,
          dose: vaccine.dose,
          dueDate: dueDate.toISOString().split('T')[0],
          status: 'pending',
          givenDate: null,
          batchNumber: null,
          givenBy: null,
          remarks: '',
          ageDays: vaccine.ageDays,
          category: vaccine.category,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
      });
      return schedule;
    }

    function viewChildDetails(childId) {
      const child = appData.children.find(c => c.id === childId);
      if (!child) {
        showNotification('Child not found.', 'error');
        return;
      }
      const modalContent = document.getElementById('childDetailsContent');
      const telephoneAddress = child.telephoneAddress || child.motherPhone || child.address || 'N/A';
      const isPhoneNumber = /^[0-9\-\+\s\(\)]{10,}$/.test(telephoneAddress.replace(/\s/g, ''));
      const ageInfo = calculateAge(child.dob);
      const isCompleted = (child.ageInMonths || calculateAgeInMonths(child.dob)) >= 60;
      modalContent.innerHTML = `
        <h3>${child.name} ${isCompleted ? '‚úÖ' : ''}</h3>
        <p><strong>Registration Number:</strong> ${child.regNo || 'N/A'}</p>
        <p><strong>Date of Birth:</strong> ${formatDate(child.dob)} (${ageInfo})</p>
        <p><strong>Sex:</strong> ${child.sex}</p>
        <p><strong>Mother:</strong> ${child.motherName}</p>
        <p><strong>Telephone/Traceable Address:</strong> ${telephoneAddress}
            ${isPhoneNumber ? `
                <button class="call-button" onclick="callMother('${telephoneAddress.replace(/'/g, "\\'")}')" title="Call mother">
                    <span class="material-icons" style="font-size: 14px;">call</span> Call
                </button>
            ` : ''}
        </p>
        <p><strong>Community:</strong> ${child.community || 'N/A'}</p>
        <p><strong>Status:</strong> ${child.isDefaulter ? '<span class="mui-chip defaulted">Defaulter</span>' : '<span class="mui-chip completed">Active</span>'}</p>
        ${isCompleted ? `
            <div style="background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; margin: 10px 0;">
                ‚úÖ <strong>COMPLETED:</strong> Child has reached 60 months. Immunization schedule is view-only.
            </div>
        ` : ''}
        <h4 style="margin-top: 20px;">Immunization Schedule</h4>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="mui-button ${!isCompleted ? '' : 'outlined'}" 
                    onclick="viewChildImmunization('${childId}')" 
                    ${isCompleted ? 'disabled' : ''}>
                <span class="material-icons">visibility</span> View Schedule
            </button>
            ${!isCompleted ? `
                <button class="mui-button secondary" onclick="updateChildImmunization('${childId}')">
                    <span class="material-icons">edit</span> Update Schedule
                </button>
                <button class="mui-button" onclick="loadChildForEdit('${childId}'); closeModal('childDetailsModal');">
                    <span class="material-icons">edit</span> Edit Details
                </button>
            ` : ''}
        </div>
        <div id="vaccinationSummary">
            ${getVaccinationSummary(child)}
        </div>
      `;
      showModal('childDetailsModal');
    }

    function viewChildImmunization(childId) {
      const child = appData.children.find(c => c.id === childId);
      if (!child) return;
      const modalContent = document.getElementById('immunizationScheduleContent');
      let scheduleHtml = '<h4>Full Immunization Schedule (View Mode)</h4>';
      scheduleHtml += '<div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">';
      scheduleHtml += '<table class="mui-table">';
      scheduleHtml += '<thead><tr><th>Vaccine</th><th>Dose</th><th>Due Date</th><th>Status</th><th>Given Date</th><th>Given By</th><th>Remarks</th></tr></thead>';
      scheduleHtml += '<tbody>';
      const schedule = child.immunizationSchedule || generateImmunizationSchedule(child.dob);
      schedule.forEach((item, index) => {
        const dueDate = new Date(item.dueDate);
        const today = new Date();
        const isOverdue = dueDate < today && item.status === 'pending';
        scheduleHtml += `
            <tr style="${isOverdue ? 'background: #ffebee;' : ''}">
                <td>${item.vaccine}</td>
                <td>${item.dose}</td>
                <td>${formatDate(item.dueDate)}</td>
                <td>
                    ${item.status === 'given' ? 
                        '<span class="mui-chip completed">Given</span>' : 
                        item.status === 'missed' ? 
                        '<span class="mui-chip defaulted">Missed</span>' : 
                        isOverdue ? 
                        '<span class="mui-chip defaulted">Overdue</span>' : 
                        '<span class="mui-chip upcoming">Pending</span>'}
                </td>
                <td>${item.givenDate ? formatDate(item.givenDate) : '-'}</td>
                <td>${item.givenBy || '-'}</td>
                <td>${item.remarks || '-'}</td>
            </tr>
        `;
      });
      scheduleHtml += '</tbody></table></div>';
      scheduleHtml += `
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button class="mui-button" onclick="viewChildDetails('${childId}')">
            <span class="material-icons">arrow_back</span> Back to Details
          </button>
          ${(child.ageInMonths || calculateAgeInMonths(child.dob)) < 60 ? `
            <button class="mui-button secondary" onclick="updateChildImmunization('${childId}')">
              <span class="material-icons">edit</span> Update Schedule
            </button>
          ` : ''}
        </div>
      `;
      modalContent.innerHTML = scheduleHtml;
      showModal('immunizationScheduleModal');
    }

    function updateChildImmunization(childId) {
      const child = appData.children.find(c => c.id === childId);
      if (!child) return;
      const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
      if (ageInMonths >= 60) {
        showNotification('Child is 60+ months. Schedule is view-only.', 'error');
        return;
      }
      const modalContent = document.getElementById('updateImmunizationContent');
      const schedule = child.immunizationSchedule || generateImmunizationSchedule(child.dob);
      let editHtml = '<h4>Update Immunization Schedule (Edit Mode)</h4>';
      editHtml += '<p style="color: var(--ghs-gray); margin-bottom: 15px;">Update vaccination status and save changes. Defaulters are automatically removed when updated.</p>';
      editHtml += '<form id="updateImmunizationForm">';
      editHtml += '<div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">';
      editHtml += '<table class="mui-table">';
      editHtml += '<thead><tr><th>Vaccine</th><th>Dose</th><th>Due Date</th><th>Status</th><th>Given Date</th><th>Batch No.</th><th>Health Worker</th><th>Remarks</th></tr></thead>';
      editHtml += '<tbody>';
      schedule.forEach((item, index) => {
        const dueDate = new Date(item.dueDate);
        const today = new Date();
        const isPastDue = dueDate < today;
        editHtml += `
            <tr style="${isPastDue && item.status === 'pending' ? 'background: #fff3e0;' : ''}">
                <td>${item.vaccine}</td>
                <td>${item.dose}</td>
                <td>${formatDate(item.dueDate)}</td>
                <td>
                    <select id="status_${index}" class="mui-select" style="min-width: 100px;" 
                            onchange="toggleVaccineDate(${index})">
                        <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="given" ${item.status === 'given' ? 'selected' : ''}>Given</option>
                        <option value="missed" ${item.status === 'missed' ? 'selected' : ''}>Missed</option>
                    </select>
                </td>
                <td>
                    <input type="date" id="givenDate_${index}" 
                           class="mui-textfield" style="min-width: 120px;"
                           value="${item.givenDate || ''}"
                           ${item.status !== 'given' ? 'disabled' : ''}>
                </td>
                <td>
                    <input type="text" id="batch_${index}" class="mui-textfield" 
                           style="min-width: 100px;" value="${item.batchNumber || ''}">
                </td>
                <td>
                    <input type="text" id="givenBy_${index}" class="mui-textfield" 
                           style="min-width: 120px;" value="${item.givenBy || currentUser?.name || ''}">
                </td>
                <td>
                    <input type="text" id="remarks_${index}" class="mui-textfield" 
                           style="min-width: 150px;" value="${item.remarks || ''}">
                </td>
            </tr>
        `;
      });
      editHtml += '</tbody></table></div>';
      editHtml += `
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button type="submit" class="mui-button">
                <span class="material-icons">save</span> Save Changes
            </button>
            <button type="button" class="mui-button secondary" onclick="viewChildImmunization('${childId}')">
                <span class="material-icons">cancel</span> Cancel
            </button>
        </div>
      `;
      editHtml += '</form>';
      modalContent.innerHTML = editHtml;
      setTimeout(() => {
        const form = document.getElementById('updateImmunizationForm');
        if (form) {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveImmunizationUpdates(childId, schedule);
          });
        }
      }, 100);
      showModal('updateImmunizationModal');
    }

    async function saveImmunizationUpdates(childId, originalSchedule) {
      const child = appData.children.find(c => c.id === childId);
      if (!child) {
        showNotification('Child not found', 'error');
        return;
      }
      try {
        showLoading('Saving immunization updates...');
        const updatedSchedule = [...originalSchedule];
        let hasChanges = false;
        let wasDefaulter = child.isDefaulter || false;
        updatedSchedule.forEach((item, index) => {
          const status = document.getElementById(`status_${index}`)?.value;
          const givenDate = document.getElementById(`givenDate_${index}`)?.value;
          const batchNumber = document.getElementById(`batch_${index}`)?.value;
          const givenBy = document.getElementById(`givenBy_${index}`)?.value;
          const remarks = document.getElementById(`remarks_${index}`)?.value;
          if (status && (status !== item.status || 
              givenDate !== item.givenDate || 
              batchNumber !== item.batchNumber ||
              givenBy !== item.givenBy ||
              remarks !== item.remarks)) {
            item.status = status;
            item.givenDate = status === 'given' ? givenDate : null;
            item.batchNumber = batchNumber;
            item.givenBy = givenBy;
            item.remarks = remarks;
            item.updatedAt = new Date().toISOString();
            item.updatedBy = currentUser.uid;
            hasChanges = true;
          }
        });
        if (!hasChanges) {
          showNotification('No changes detected', 'info');
          hideLoading();
          return;
        }
        const pendingVaccines = updatedSchedule.filter(v => v.status === 'pending');
        let nextVisit = null;
        if (pendingVaccines.length > 0) {
          const earliestPending = pendingVaccines.reduce((earliest, current) => {
            const currentDate = new Date(current.dueDate);
            const earliestDate = earliest ? new Date(earliest.dueDate) : new Date('9999-12-31');
            return currentDate < earliestDate ? current : earliest;
          });
          nextVisit = earliestPending.dueDate;
        }
        const today = new Date();
        const hasOverdueVaccines = updatedSchedule.some(v => {
          if (v.status === 'pending') {
            const dueDate = new Date(v.dueDate);
            const daysOverdue = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
            return daysOverdue > 7;
          }
          return false;
        });
        const isDefaulter = hasOverdueVaccines;
        const childRef = firestore.doc(db, `child_health_register/${childId}`);
        await firestore.updateDoc(childRef, {
          immunizationSchedule: updatedSchedule,
          nextVisit: nextVisit,
          isDefaulter: isDefaulter,
          lastDefaulterCheck: firestore.Timestamp.now(),
          vaccinations: updatedSchedule.filter(v => v.status === 'given').map(v => ({
            vaccine: v.vaccine,
            dose: v.dose,
            date: v.givenDate,
            batchNumber: v.batchNumber,
            givenBy: v.givenBy
          })),
          updatedAt: firestore.serverTimestamp()
        });
        const childIndex = appData.children.findIndex(c => c.id === childId);
        if (childIndex !== -1) {
          appData.children[childIndex].immunizationSchedule = updatedSchedule;
          appData.children[childIndex].nextVisit = nextVisit;
          appData.children[childIndex].isDefaulter = isDefaulter;
          appData.children[childIndex].vaccinations = updatedSchedule
            .filter(v => v.status === 'given')
            .map(v => ({
              vaccine: v.vaccine,
              dose: v.dose,
              date: v.givenDate,
              batchNumber: v.batchNumber,
              givenBy: v.givenBy
            }));
        }
        if (wasDefaulter && !isDefaulter) {
          updateDefaultersListEnhanced();
          showNotification('Child removed from defaulters list!', 'success');
        } else if (!wasDefaulter && isDefaulter) {
          updateDefaultersListEnhanced();
          showNotification('Child added to defaulters list!', 'warning');
        }
        updateChildrenTable();
        updateStats();
        showNotification('Immunization schedule updated successfully!', 'success');
        closeModal('updateImmunizationModal');
        viewChildImmunization(childId);
      } catch (error) {
        showNotification('Failed to save updates: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    function toggleVaccineDate(index) {
      const statusSelect = document.getElementById(`status_${index}`);
      const dateInput = document.getElementById(`givenDate_${index}`);
      if (statusSelect && dateInput) {
        if (statusSelect.value === 'given') {
          dateInput.disabled = false;
          if (!dateInput.value) {
            dateInput.valueAsDate = new Date();
          }
        } else {
          dateInput.disabled = true;
          dateInput.value = '';
        }
      }
    }

    function getVaccinationSummary(child) {
      const schedule = child.immunizationSchedule || generateImmunizationSchedule(child.dob);
      const totalVaccines = schedule.length;
      const givenVaccines = schedule.filter(v => v.status === 'given').length;
      const pendingVaccines = schedule.filter(v => v.status === 'pending').length;
      const missedVaccines = schedule.filter(v => v.status === 'missed').length;
      const percentage = totalVaccines > 0 ? Math.round((givenVaccines / totalVaccines) * 100) : 0;
      return `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
            <h5 style="margin-bottom: 10px;">Immunization Progress</h5>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #006400;">${percentage}%</div>
                    <div style="font-size: 12px; color: #666;">Completion</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">${givenVaccines}</div>
                    <div style="font-size: 12px; color: #666;">Given</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #ef6c00;">${pendingVaccines}</div>
                    <div style="font-size: 12px; color: #666;">Pending</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #c62828;">${missedVaccines}</div>
                    <div style="font-size: 12px; color: #666;">Missed</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #0066CC;">${totalVaccines}</div>
                    <div style="font-size: 12px; color: #666;">Total Required</div>
                </div>
            </div>
            <div style="margin-top: 10px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                <div style="width: ${percentage}%; height: 100%; background: #006400; transition: width 0.3s;"></div>
            </div>
        </div>
      `;
    }

    function calculateAge(dob) {
      if (!dob) return 'N/A';
      const birthDate = new Date(dob);
      const today = new Date();
      let years = today.getFullYear() - birthDate.getFullYear();
      let months = today.getMonth() - birthDate.getMonth();
      let days = today.getDate() - birthDate.getDate();
      if (days < 0) {
        months--;
        const prevMonth = new Date(today.getFullYear(), today.getMonth(), 0);
        days += prevMonth.getDate();
      }
      if (months < 0) {
        years--;
        months += 12;
      }
      const ageInMonths = (years * 12) + months;
      if (years > 0) {
        return `${years}y ${months}m ${days}d (${ageInMonths} months)`;
      } else if (months > 0) {
        return `${months}m ${days}d (${ageInMonths} months)`;
      } else {
        return `${days}d (${ageInMonths} months)`;
      }
    }

    function calculateAgeInMonths(dob) {
      if (!dob) return 0;
      const birthDate = new Date(dob);
      const today = new Date();
      let years = today.getFullYear() - birthDate.getFullYear();
      let months = today.getMonth() - birthDate.getMonth();
      if (today.getDate() < birthDate.getDate()) {
        months--;
      }
      if (months < 0) {
        years--;
        months += 12;
      }
      return (years * 12) + months;
    }

    function updateDefaultersListEnhanced() {
      try {
        const defaultersTableBody = document.getElementById('defaultersTableBody');
        const noDefaultersMessage = document.getElementById('noDefaultersMessage');
        if (!defaultersTableBody) return;
        defaultersTableBody.innerHTML = '';
        if (!appData.defaulters) appData.defaulters = [];
        if (!appData.children || !Array.isArray(appData.children)) appData.children = [];
        const periodFilter = document.getElementById('defaulterPeriod')?.value || '7';
        const vaccineFilter = document.getElementById('defaulterVaccine')?.value || 'all';
        const communityFilter = document.getElementById('defaulterCommunity')?.value || 'all';
        updateCommunitiesDropdown();
        const today = new Date();
        const newDefaulters = [];
        const processedChildIds = new Set();
        const activeChildren = appData.children.filter(child => {
          try {
            if (!child || !child.dob) return false;
            const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
            return ageInMonths < 60;
          } catch (error) {
            return false;
          }
        });
        activeChildren.forEach((child) => {
          try {
            if (processedChildIds.has(child.id)) return;
            if (communityFilter !== 'all' && child.community !== communityFilter) return;
            const schedule = child.immunizationSchedule || generateImmunizationSchedule(child.dob);
            const overdueVaccines = [];
            schedule.forEach(vaccine => {
              try {
                if (vaccine.status === 'pending') {
                  const dueDate = new Date(vaccine.dueDate);
                  if (isNaN(dueDate.getTime())) return;
                  const daysOverdue = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                  if (daysOverdue > parseInt(periodFilter) || periodFilter === 'all') {
                    if (vaccineFilter === 'all' || 
                        vaccine.vaccine.includes(vaccineFilter) || 
                        (vaccineFilter === 'Measles' && vaccine.vaccine.includes('Measles'))) {
                      overdueVaccines.push({
                        ...vaccine,
                        daysOverdue: daysOverdue
                      });
                    }
                  }
                }
              } catch (error) {}
            });
            if (overdueVaccines.length > 0) {
              processedChildIds.add(child.id);
              const allMissedVaccines = overdueVaccines.map(v => `${v.vaccine} (${v.daysOverdue}d)`).join(', ');
              const mostOverdue = overdueVaccines.reduce((most, current) => 
                current.daysOverdue > most.daysOverdue ? current : most
              );
              newDefaulters.push({
                childId: child.id,
                childName: child.name || 'Unknown',
                age: calculateAge(child.dob),
                motherName: child.motherName || 'Unknown',
                telephone: child.telephoneAddress || child.motherPhone || child.address || 'N/A',
                community: child.community || 'Unknown',
                missedVaccine: allMissedVaccines,
                dueDate: mostOverdue.dueDate,
                daysOverdue: mostOverdue.daysOverdue,
                allOverdueVaccines: overdueVaccines,
                overdueCount: overdueVaccines.length
              });
            }
          } catch (error) {}
        });
        newDefaulters.sort((a, b) => b.daysOverdue - a.daysOverdue);
        appData.defaulters = newDefaulters;
        if (appData.defaulters.length === 0) {
          defaultersTableBody.style.display = 'none';
          if (noDefaultersMessage) noDefaultersMessage.style.display = 'block';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td colspan="10" style="text-align: center; padding: 40px; color: var(--ghs-gray);">
              <span class="material-icons" style="font-size: 48px; opacity: 0.5;">check_circle</span>
              <p style="margin-top: 16px;">No defaulters found. Great work!</p>
            </td>
          `;
          defaultersTableBody.appendChild(row);
        } else {
          defaultersTableBody.style.display = '';
          if (noDefaultersMessage) noDefaultersMessage.style.display = 'none';
          appData.defaulters.forEach((defaulter, index) => {
            try {
              const row = document.createElement('tr');
              const isPhoneNumber = /^[0-9\-\+\s\(\)]{10,}$/.test((defaulter.telephone || '').replace(/\s/g, ''));
              row.innerHTML = `
                <td>${index + 1}</td>
                <td>${defaulter.childName}</td>
                <td>${defaulter.age}</td>
                <td>${defaulter.motherName}</td>
                <td>
                  ${defaulter.telephone}
                  ${isPhoneNumber ? `
                    <button class="call-button" onclick="callMother('${defaulter.telephone.replace(/'/g, "\\'")}')" title="Call mother">
                      <span class="material-icons" style="font-size: 14px;">call</span>
                    </button>
                  ` : ''}
                </td>
                <td>${defaulter.missedVaccine} <span style="color: var(--ghs-red); font-size: 11px;">(${defaulter.overdueCount} vaccines)</span></td>
                <td>${formatDate(defaulter.dueDate)}</td>
                <td><span class="mui-chip defaulted">${defaulter.daysOverdue} days</span></td>
                <td>${defaulter.community}</td>
                <td>
                  <div class="user-table-actions">
                    <button class="mui-button" style="padding: 4px 8px; font-size: 12px;" 
                            onclick="viewDefaulterDetails('${defaulter.childId}')">
                      View
                    </button>
                    <button class="mui-button secondary" style="padding: 4px 8px; font-size: 12px;" 
                            onclick="updateChildImmunization('${defaulter.childId}')">
                      Update
                    </button>
                  </div>
                </td>
              `;
              defaultersTableBody.appendChild(row);
            } catch (error) {}
          });
        }
        updateStats();
      } catch (error) {
        const defaultersTableBody = document.getElementById('defaultersTableBody');
        if (defaultersTableBody) {
          defaultersTableBody.innerHTML = `
            <tr>
              <td colspan="10" style="text-align: center; padding: 40px; color: var(--ghs-red);">
                <span class="material-icons" style="font-size: 48px;">error</span>
                <p style="margin-top: 16px;">Error loading defaulters. Please try refreshing.</p>
                <button class="mui-button" onclick="updateDefaultersListEnhanced()" style="margin-top: 10px;">
                  Retry
                </button>
              </td>
            </tr>
          `;
        }
      }
    }

    function viewDefaulterDetails(childId) {
      const child = appData.children.find(c => c.id === childId);
      if (!child) return;
      const defaulter = appData.defaulters.find(d => d.childId === childId);
      const modalContent = document.getElementById('defaulterDetailsContent');
      let overdueVaccinesHtml = '';
      if (defaulter && defaulter.allOverdueVaccines) {
        overdueVaccinesHtml = '<h4 style="margin-top: 20px;">Overdue Vaccines</h4>';
        overdueVaccinesHtml += '<table class="mui-table" style="margin-top: 10px; font-size: 13px;">';
        overdueVaccinesHtml += '<thead><tr><th>Vaccine</th><th>Due Date</th><th>Days Overdue</th><th>Dose</th></tr></thead>';
        overdueVaccinesHtml += '<tbody>';
        defaulter.allOverdueVaccines.forEach(vaccine => {
          overdueVaccinesHtml += `
            <tr>
              <td>${vaccine.vaccine}</td>
              <td>${formatDate(vaccine.dueDate)}</td>
              <td><span class="mui-chip defaulted">${vaccine.daysOverdue} days</span></td>
              <td>${vaccine.dose}</td>
            </tr>
          `;
        });
        overdueVaccinesHtml += '</tbody></table>';
      }
      modalContent.innerHTML = `
        <h3>${child.name} - Defaulter Details</h3>
        <p><strong>Registration Number:</strong> ${child.regNo || 'N/A'}</p>
        <p><strong>Date of Birth:</strong> ${formatDate(child.dob)} (${calculateAge(child.dob)})</p>
        <p><strong>Mother:</strong> ${child.motherName}</p>
        <p><strong>Telephone:</strong> ${child.telephoneAddress || 'N/A'}</p>
        <p><strong>Community:</strong> ${child.community || 'N/A'}</p>
        <p><strong>Status:</strong> <span class="mui-chip defaulted">Defaulter</span></p>
        <p><strong>Total Missed Vaccines:</strong> ${defaulter?.allOverdueVaccines?.length || 0}</p>
        ${overdueVaccinesHtml}
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button class="mui-button" onclick="updateChildImmunization('${childId}')">
            <span class="material-icons">edit</span> Update Immunization
          </button>
          <button class="mui-button" onclick="loadChildForEdit('${childId}'); closeModal('defaulterDetailsModal');">
            <span class="material-icons">edit</span> Edit Details
          </button>
          <button class="mui-button secondary" onclick="closeModal('defaulterDetailsModal')">
            <span class="material-icons">close</span> Close
          </button>
        </div>
      `;
      showModal('defaulterDetailsModal');
    }

    function updateCommunitiesDropdown() {
      const communitySelect = document.getElementById('defaulterCommunity');
      if (!communitySelect) return;
      const communities = [...new Set(appData.children
        .map(child => child.community)
        .filter(community => community && community.trim() !== '')
      )];
      const currentSelection = communitySelect.value;
      communitySelect.innerHTML = '<option value="all">All Communities</option>';
      communities.sort().forEach(community => {
        const option = document.createElement('option');
        option.value = community;
        option.textContent = community;
        communitySelect.appendChild(option);
      });
      if (currentSelection && communities.includes(currentSelection)) {
        communitySelect.value = currentSelection;
      }
    }

    function refreshDefaulters() {
      updateDefaultersListEnhanced();
      showNotification('Defaulters list refreshed!', 'success');
    }

    function exportDefaultersToExcel() {
      try {
        if (!appData.defaulters || appData.defaulters.length === 0) {
          showNotification('No defaulters to export.', 'info');
          return;
        }
        showLoading('Exporting defaulters...');
        const data = appData.defaulters.map((defaulter, index) => ({
          '#': index + 1,
          'Child Name': defaulter.childName || 'N/A',
          'Age': defaulter.age || 'N/A',
          'Mother Name': defaulter.motherName || 'N/A',
          'Telephone': defaulter.telephone || 'N/A',
          'Community': defaulter.community || 'N/A',
          'Missed Vaccine(s)': defaulter.missedVaccine || 'N/A',
          'Due Date': defaulter.dueDate ? formatDate(defaulter.dueDate) : 'N/A',
          'Days Overdue': defaulter.daysOverdue || 0,
          'Status': 'Defaulter'
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Defaulters');
        const summaryData = [
          ['Immunization Defaulters Report'],
          ['Facility:', currentFacility?.name || 'N/A'],
          ['Report Date:', new Date().toLocaleDateString()],
          ['Total Defaulters:', appData.defaulters.length],
          [''],
          ['Summary Statistics'],
          ['Average Days Overdue:', Math.round(appData.defaulters.reduce((sum, d) => sum + (d.daysOverdue || 0), 0) / appData.defaulters.length)],
          ['Communities Affected:', [...new Set(appData.defaulters.map(d => d.community || 'Unknown'))].length],
          ['Most Common Missed Vaccine:', getMostCommonMissedVaccine()]
        ];
        const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, ws2, 'Summary');
        const fileName = `immunization_defaulters_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        showNotification(`Defaulters exported to ${fileName} successfully!`, 'success');
      } catch (error) {
        showNotification('Failed to export defaulters: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    function getMostCommonMissedVaccine() {
      if (!appData.defaulters || appData.defaulters.length === 0) return 'N/A';
      const vaccineCounts = {};
      appData.defaulters.forEach(defaulter => {
        if (defaulter.missedVaccine) {
          const vaccines = defaulter.missedVaccine.split(', ');
          vaccines.forEach(vaccine => {
            const cleanVaccine = vaccine.split(' (')[0];
            vaccineCounts[cleanVaccine] = (vaccineCounts[cleanVaccine] || 0) + 1;
          });
        }
      });
      let mostCommon = 'N/A';
      let maxCount = 0;
      for (const [vaccine, count] of Object.entries(vaccineCounts)) {
        if (count > maxCount) {
          maxCount = count;
          mostCommon = vaccine;
        }
      }
      return mostCommon;
    }

    function exportChildrenToExcel() {
      try {
        showLoading('Exporting children data...');
        const activeChildren = appData.children.filter(child => {
          const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
          return ageInMonths < 60;
        });
        const data = activeChildren.map((child, index) => ({
          '#': index + 1,
          'Registration Number': child.regNo || '',
          'Name': child.name,
          'Date of Birth': child.dob ? formatDate(child.dob) : '',
          'Age': calculateAge(child.dob),
          'Sex': child.sex,
          'Mother': child.motherName,
          'Telephone/Address': child.telephoneAddress || child.motherPhone || child.address || '',
          'Community': child.community || '',
          'Status': child.isDefaulter ? 'Defaulter' : 'Active',
          'Next Visit': child.nextVisit ? formatDate(child.nextVisit) : '',
          'Total Vaccinations': child.vaccinations ? child.vaccinations.length : 0,
          'Immunization Completion': calculateImmunizationCompletion(child) + '%'
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Children');
        XLSX.writeFile(wb, `immunization_children_${new Date().toISOString().split('T')[0]}.xlsx`);
        showNotification('Children data exported to Excel successfully!', 'success');
      } catch (error) {
        showNotification('Failed to export children data: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    function calculateImmunizationCompletion(child) {
      const schedule = child.immunizationSchedule || generateImmunizationSchedule(child.dob);
      const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
      const ageAppropriateVaccines = schedule.filter(v => {
        const vaccineAgeMonths = v.ageDays / 30.44;
        return vaccineAgeMonths <= ageInMonths;
      }).length;
      const ageAppropriateGiven = schedule.filter(v => {
        const vaccineAgeMonths = v.ageDays / 30.44;
        return vaccineAgeMonths <= ageInMonths && v.status === 'given';
      }).length;
      return ageAppropriateVaccines > 0 ? 
        Math.round((ageAppropriateGiven / ageAppropriateVaccines) * 100) : 0;
    }

    function exportChildrenToPDF() {
      try {
        showLoading('Generating children PDF report...');
        const pdfContent = document.createElement('div');
        pdfContent.style.padding = '20px';
        pdfContent.style.backgroundColor = 'white';
        const today = new Date();
        const dateStr = today.toLocaleDateString();
        const activeChildren = appData.children.filter(child => {
          const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
          return ageInMonths < 60;
        });
        pdfContent.innerHTML = `
          <h2 style="color: #006400; text-align: center;">Children Register Report</h2>
          <h3 style="text-align: center;">Ghana Health Service</h3>
          <p style="text-align: center;">Generated on: ${dateStr}</p>
          <p style="text-align: center;">Facility: ${currentFacility?.name || 'N/A'}</p>
          <hr style="margin: 20px 0;">
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
              <h4>Total Children</h4>
              <div style="font-size: 24px; font-weight: bold; color: #006400;">${activeChildren.length}</div>
            </div>
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
              <h4>Defaulters</h4>
              <div style="font-size: 24px; font-weight: bold; color: #CE1126;">${appData.defaulters.length}</div>
            </div>
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
              <h4>Avg. Completion</h4>
              <div style="font-size: 24px; font-weight: bold; color: #0066CC;">${calculateAverageCompletion()}%</div>
            </div>
          </div>
        `;
        if (activeChildren.length > 0) {
          pdfContent.innerHTML += `
            <h3>Children Register (0-59 months)</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px;">
              <thead>
                <tr style="background: #006400; color: white;">
                  <th style="padding: 8px; border: 1px solid #ddd;">Reg No</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Name</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Age</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Mother</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Community</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Vaccinations</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Status</th>
                </tr>
              </thead>
              <tbody>
                ${activeChildren.slice(0, 100).map((child, index) => {
                  const vaccinationsCount = child.vaccinations ? child.vaccinations.length : 0;
                  const completion = calculateImmunizationCompletion(child);
                  return `
                    <tr style="${index % 2 === 0 ? 'background: #f9f9f9;' : ''}">
                      <td style="padding: 8px; border: 1px solid #ddd;">${child.regNo || 'N/A'}</td>
                      <td style="padding: 8px; border: 1px solid #ddd;">${child.name}</td>
                      <td style="padding: 8px; border: 1px solid #ddd;">${calculateAge(child.dob)}</td>
                      <td style="padding: 8px; border: 1px solid #ddd;">${child.motherName}</td>
                      <td style="padding: 8px; border: 1px solid #ddd;">${child.community || 'N/A'}</td>
                      <td style="padding: 8px; border: 1px solid #ddd;">${vaccinationsCount} (${completion}%)</td>
                      <td style="padding: 8px; border: 1px solid #ddd;">${child.isDefaulter ? 'Defaulter' : 'Active'}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
            ${activeChildren.length > 100 ? `<p style="margin-top: 10px; font-style: italic;">Showing first 100 of ${activeChildren.length} children</p>` : ''}
          `;
        }
        pdfContent.innerHTML += `
          <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #006400;">
            <p style="text-align: center; color: #666; font-size: 12px;">
              Children Register Report - Ghana Health Service<br>
              Immunization Tracker v5.0 - ${dateStr}
            </p>
          </div>
        `;
        document.body.appendChild(pdfContent);
        html2canvas(pdfContent).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
          const imgWidth = 210;
          const imgHeight = canvas.height * imgWidth / canvas.width;
          pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
          pdf.save(`children_register_${new Date().toISOString().split('T')[0]}.pdf`);
          document.body.removeChild(pdfContent);
          showNotification('Children PDF report generated successfully!', 'success');
          hideLoading();
        });
      } catch (error) {
        showNotification('Failed to generate children PDF: ' + error.message, 'error');
        hideLoading();
      }
    }

    function calculateAverageCompletion() {
      const activeChildren = appData.children.filter(child => {
        const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
        return ageInMonths < 60;
      });
      if (activeChildren.length === 0) return 0;
      const totalCompletion = activeChildren.reduce((sum, child) => {
        return sum + calculateImmunizationCompletion(child);
      }, 0);
      return Math.round(totalCompletion / activeChildren.length);
    }

    function exportDefaultersToPDF() {
      try {
        showLoading('Generating defaulters PDF...');
        const pdfContent = document.createElement('div');
        pdfContent.style.padding = '20px';
        pdfContent.style.backgroundColor = 'white';
        const today = new Date();
        const dateStr = today.toLocaleDateString();
        pdfContent.innerHTML = `
          <h2 style="color: #CE1126; text-align: center;">Immunization Defaulters Report</h2>
          <h3 style="text-align: center;">Ghana Health Service</h3>
          <p style="text-align: center;">Generated on: ${dateStr}</p>
          <p style="text-align: center;">Facility: ${currentFacility?.name || 'N/A'}</p>
          <hr style="margin: 20px 0;">
          <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3>Summary</h3>
            <p>Total Defaulters: <strong>${appData.defaulters.length}</strong></p>
            <p>Report Period: Last 7+ days overdue</p>
            <p>Average Days Overdue: <strong>${appData.defaulters.length > 0 ? Math.round(appData.defaulters.reduce((sum, d) => sum + (d.daysOverdue || 0), 0) / appData.defaulters.length) : 0}</strong> days</p>
          </div>
        `;
        if (appData.defaulters.length > 0) {
          pdfContent.innerHTML += `
            <h3>Defaulters List</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px;">
              <thead>
                <tr style="background: #CE1126; color: white;">
                  <th style="padding: 8px; border: 1px solid #ddd;">#</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Child Name</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Age</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Mother</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Telephone</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Missed Vaccine(s)</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Days Overdue</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Community</th>
                </tr>
              </thead>
              <tbody>
                ${appData.defaulters.map((defaulter, index) => `
                  <tr style="${index % 2 === 0 ? 'background: #f9f9f9;' : ''}">
                    <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.childName}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.age}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.motherName}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.telephone}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.missedVaccine}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.daysOverdue}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.community}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          pdfContent.innerHTML += `
            <div style="text-align: center; padding: 40px; color: #666;">
              <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
              <h3>No Defaulters Found</h3>
              <p>Excellent work! All children are up-to-date with their immunizations.</p>
            </div>
          `;
        }
        pdfContent.innerHTML += `
          <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #CE1126;">
            <p style="text-align: center; color: #666; font-size: 12px;">
              Defaulters Report - Ghana Health Service<br>
              Immunization Tracker v5.0 - ${dateStr}
            </p>
          </div>
        `;
        document.body.appendChild(pdfContent);
        html2canvas(pdfContent).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
          const imgWidth = 210;
          const imgHeight = canvas.height * imgWidth / canvas.width;
          pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
          pdf.save(`defaulters_report_${new Date().toISOString().split('T')[0]}.pdf`);
          document.body.removeChild(pdfContent);
          showNotification('Defaulters PDF generated successfully!', 'success');
          hideLoading();
        });
      } catch (error) {
        showNotification('Failed to generate defaulters PDF: ' + error.message, 'error');
        hideLoading();
      }
    }

    function exportDefaultersToCSV() {
      try {
        if (!appData.defaulters || appData.defaulters.length === 0) {
          showNotification('No defaulters to export.', 'info');
          return;
        }
        const data = appData.defaulters.map((defaulter, index) => ({
          '#': index + 1,
          'Child Name': defaulter.childName || 'N/A',
          'Age': defaulter.age || 'N/A',
          'Mother Name': defaulter.motherName || 'N/A',
          'Telephone': defaulter.telephone || 'N/A',
          'Community': defaulter.community || 'N/A',
          'Missed Vaccine(s)': defaulter.missedVaccine || 'N/A',
          'Due Date': defaulter.dueDate ? formatDate(defaulter.dueDate) : 'N/A',
          'Days Overdue': defaulter.daysOverdue || 0
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const csv = XLSX.utils.sheet_to_csv(ws);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `defaulters_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        showNotification('Defaulters exported to CSV successfully!', 'success');
      } catch (error) {
        showNotification('Failed to export CSV: ' + error.message, 'error');
      }
    }

    function exportToPDF() {
      try {
        showLoading('Generating PDF report...');
        const pdfContent = document.createElement('div');
        pdfContent.style.padding = '20px';
        pdfContent.style.backgroundColor = 'white';
        const today = new Date();
        const dateStr = today.toLocaleDateString();
        pdfContent.innerHTML = `
          <h2 style="color: #006400; text-align: center;">Immunization Tracker Report</h2>
          <h3 style="text-align: center;">Ghana Health Service</h3>
          <p style="text-align: center;">Generated on: ${dateStr}</p>
          <p style="text-align: center;">Facility: ${currentFacility?.name || 'N/A'}</p>
          <hr style="margin: 20px 0;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
              <h4>Total Children (0-59 months)</h4>
              <div style="font-size: 24px; font-weight: bold; color: #006400;">${appData.children.filter(c => {
                const ageInMonths = c.ageInMonths || calculateAgeInMonths(c.dob);
                return ageInMonths < 60;
              }).length}</div>
            </div>
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
              <h4>Active Defaulters</h4>
              <div style="font-size: 24px; font-weight: bold; color: #CE1126;">${appData.defaulters.length}</div>
            </div>
          </div>
        `;
        if (appData.defaulters.length > 0) {
          pdfContent.innerHTML += `
            <h3>Defaulters List</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background: #006400; color: white;">
                  <th style="padding: 8px; border: 1px solid #ddd;">Child Name</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Age</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Mother</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Missed Vaccine(s)</th>
                  <th style="padding: 8px; border: 1px solid #ddd;">Days Overdue</th>
                </tr>
              </thead>
              <tbody>
                ${appData.defaulters.map((defaulter, index) => `
                  <tr style="${index % 2 === 0 ? 'background: #f9f9f9;' : ''}">
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.childName}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.age}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.motherName}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.missedVaccine}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${defaulter.daysOverdue}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
        const activeChildren = appData.children.filter(child => {
          const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
          return ageInMonths < 60;
        });
        pdfContent.innerHTML += `
          <h3 style="margin-top: 30px;">Children Summary (${activeChildren.length} active children)</h3>
          <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
              <tr style="background: #006400; color: white;">
                <th style="padding: 8px; border: 1px solid #ddd;">Name</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Age</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Mother</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Vaccinations Given</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Status</th>
              </tr>
            </thead>
            <tbody>
              ${activeChildren.slice(0, 50).map((child, index) => {
                const vaccinationsCount = child.vaccinations ? child.vaccinations.length : 0;
                const isDefaulter = child.isDefaulter || false;
                return `
                  <tr style="${index % 2 === 0 ? 'background: #f9f9f9;' : ''}">
                    <td style="padding: 8px; border: 1px solid #ddd;">${child.name}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${calculateAge(child.dob)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${child.motherName}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${vaccinationsCount}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${isDefaulter ? 'Defaulter' : 'Active'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          ${activeChildren.length > 50 ? `<p style="margin-top: 10px; font-style: italic;">Showing first 50 of ${activeChildren.length} children</p>` : ''}
          <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #006400;">
            <p style="text-align: center; color: #666; font-size: 12px;">
              Report generated by Immunization Tracker v5.0<br>
              Ghana Health Service - No Child Left Behind
            </p>
          </div>
        `;
        document.body.appendChild(pdfContent);
        html2canvas(pdfContent).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
          const imgWidth = 210;
          const pageHeight = 295;
          const imgHeight = canvas.height * imgWidth / canvas.width;
          let heightLeft = imgHeight;
          let position = 0;
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }
          pdf.save(`immunization_report_${new Date().toISOString().split('T')[0]}.pdf`);
          document.body.removeChild(pdfContent);
          showNotification('PDF report generated successfully!', 'success');
          hideLoading();
        }).catch(error => {
          document.body.removeChild(pdfContent);
          const pdf = new jspdf.jsPDF();
          pdf.text('Immunization Tracker Report', 20, 20);
          pdf.text(`Facility: ${currentFacility?.name || 'N/A'}`, 20, 30);
          pdf.text(`Date: ${dateStr}`, 20, 40);
          pdf.text(`Total Children: ${activeChildren.length}`, 20, 50);
          pdf.text(`Defaulters: ${appData.defaulters.length}`, 20, 60);
          pdf.save(`immunization_report_${new Date().toISOString().split('T')[0]}.pdf`);
          showNotification('Simple PDF generated successfully!', 'success');
          hideLoading();
        });
      } catch (error) {
        showNotification('Failed to generate PDF: ' + error.message, 'error');
        hideLoading();
      }
    }

    function checkAndUpdateAgeStatus() {
      appData.children.forEach(async (child, index) => {
        const ageInMonths = calculateAgeInMonths(child.dob);
        if (ageInMonths >= 60 && child.status !== 'completed') {
          try {
            const schedule = child.immunizationSchedule || generateImmunizationSchedule(child.dob);
            const givenVaccines = schedule.filter(v => v.status === 'given').length;
            const totalVaccines = schedule.length;
            const completionRate = totalVaccines > 0 ? Math.round((givenVaccines / totalVaccines) * 100) : 0;
            const childRef = firestore.doc(db, `child_health_register/${child.id}`);
            await firestore.updateDoc(childRef, {
              status: 'completed',
              completedAt: firestore.serverTimestamp(),
              remarks: `Child reached 60 months (5 years). Immunization completion rate: ${completionRate}%.`,
              isDefaulter: false,
              updatedAt: firestore.serverTimestamp()
            });
            appData.children[index].status = 'completed';
            appData.children[index].completedAt = new Date();
            appData.children[index].isDefaulter = false;
            const defaulterIndex = appData.defaulters.findIndex(d => d.childId === child.id);
            if (defaulterIndex !== -1) {
              appData.defaulters.splice(defaulterIndex, 1);
            }
          } catch (error) {}
        }
      });
      updateDefaultersListEnhanced();
    }

    function updateChildrenTable() {
      const tableBody = document.getElementById('childrenTableBody');
      if (!tableBody) return;
      tableBody.innerHTML = '';
      if (appData.children.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="8" style="text-align: center; padding: 40px; color: var(--ghs-gray);">
            <span class="material-icons" style="font-size: 48px; opacity: 0.5;">child_care</span>
            <p style="margin-top: 16px;">No children registered yet.</p>
          </td>
        `;
        tableBody.appendChild(row);
        return;
      }
      const uniqueChildren = [];
      const seenIds = new Set();
      appData.children.forEach((child) => {
        if (!seenIds.has(child.id)) {
          seenIds.add(child.id);
          uniqueChildren.push(child);
        }
      });
      const activeChildren = uniqueChildren.filter(child => {
        const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
        return ageInMonths < 60;
      });
      const sortedChildren = [...activeChildren].sort((a, b) => {
        const regNoA = a.regNo || '';
        const regNoB = b.regNo || '';
        return regNoA.localeCompare(regNoB);
      });
      sortedChildren.forEach((child) => {
        const row = document.createElement('tr');
        const ageInMonths = calculateAgeInMonths(child.dob);
        const isCompleted = ageInMonths >= 60;
        let nextVisitText = 'N/A';
        let statusBadge = '<span class="mui-chip completed">Active</span>';
        if (child.nextVisit) {
          const nextVisitDate = new Date(child.nextVisit);
          const today = new Date();
          const daysUntilVisit = Math.ceil((nextVisitDate - today) / (1000 * 60 * 60 * 24));
          nextVisitText = formatDate(child.nextVisit);
          if (daysUntilVisit <= 7 && daysUntilVisit > 0) {
            statusBadge = '<span class="mui-chip due">Due Soon</span>';
          } else if (daysUntilVisit < 0) {
            statusBadge = `<span class="mui-chip defaulted">Overdue ${Math.abs(daysUntilVisit)} days</span>`;
          }
        }
        if (child.isDefaulter) {
          statusBadge = '<span class="mui-chip defaulted">Defaulter</span>';
        }
        if (isCompleted) {
          statusBadge = '<span class="mui-chip completed">Completed</span>';
        }
        const telephoneAddress = child.telephoneAddress || 'N/A';
        const isPhoneNumber = /^[0-9\-\+\s\(\)]{10,}$/.test(telephoneAddress.replace(/\s/g, ''));
        row.innerHTML = `
          <td>${child.regNo || 'N/A'}</td>
          <td>${child.name}</td>
          <td>${calculateAge(child.dob)}</td>
          <td>${child.motherName}</td>
          <td>
            ${telephoneAddress}
            ${isPhoneNumber ? `
              <button class="call-button" onclick="callMother('${telephoneAddress.replace(/'/g, "\\'")}')">
                <span class="material-icons" style="font-size: 14px;">call</span>
              </button>
            ` : ''}
          </td>
          <td>${nextVisitText}</td>
          <td>${statusBadge}</td>
          <td>
            <div class="user-table-actions">
              <button class="mui-button" style="padding: 4px 8px; font-size: 12px;" 
                      onclick="viewChildDetails('${child.id}')">
                Manage
              </button>
              ${!isCompleted ? `
                <button class="mui-button secondary" style="padding: 4px 8px; font-size: 12px;" 
                        onclick="updateChildImmunization('${child.id}')">Update</button>
              ` : ''}
              <button class="mui-button danger" style="padding: 4px 8px; font-size: 12px;" 
                      onclick="deleteChild('${child.id}')">Delete</button>
            </div>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    async function deleteChild(childId) {
      if (!confirm('Are you sure you want to delete this child record? This action cannot be undone.')) {
        return;
      }
      try {
        showLoading('Deleting child record...');
        const childRef = firestore.doc(db, `child_health_register/${childId}`);
        await firestore.deleteDoc(childRef);
        const childIndex = appData.children.findIndex(c => c.id === childId);
        if (childIndex !== -1) {
          appData.children.splice(childIndex, 1);
        }
        const defaulterIndex = appData.defaulters.findIndex(d => d.childId === childId);
        if (defaulterIndex !== -1) {
          appData.defaulters.splice(defaulterIndex, 1);
        }
        updateStats();
        updateChildrenTable();
        updateDefaultersListEnhanced();
        showNotification('Child record deleted successfully!', 'success');
      } catch (error) {
        showNotification('Failed to delete child record: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    function filterChildrenOptimized() {
      const searchTerm = document.getElementById('searchChild').value.toLowerCase().trim();
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      searchTimeout = setTimeout(() => {
        filterChildren();
      }, 300);
    }

    function filterChildren() {
      const searchTerm = document.getElementById('searchChild').value.toLowerCase().trim();
      const tableBody = document.getElementById('childrenTableBody');
      if (!tableBody) return;
      const rows = tableBody.getElementsByTagName('tr');
      let visibleCount = 0;
      for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        let shouldShow = false;
        if (cells.length === 1) {
          row.style.display = searchTerm ? 'none' : '';
          continue;
        }
        if (searchTerm) {
          for (let cell of cells) {
            if (cell.textContent.toLowerCase().includes(searchTerm)) {
              shouldShow = true;
              break;
            }
          }
          const regNoCell = cells[0]?.textContent.toLowerCase();
          const nameCell = cells[1]?.textContent.toLowerCase();
          const motherCell = cells[3]?.textContent.toLowerCase();
          const phoneCell = cells[4]?.textContent.toLowerCase();
          if (!shouldShow) {
            shouldShow = regNoCell.includes(searchTerm) ||
                       nameCell.includes(searchTerm) ||
                       motherCell.includes(searchTerm) ||
                       phoneCell.includes(searchTerm);
          }
        } else {
          shouldShow = true;
        }
        row.style.display = shouldShow ? '' : 'none';
        if (shouldShow) visibleCount++;
      }
      if (searchTerm && visibleCount === 0) {
        const noResultsRow = document.createElement('tr');
        noResultsRow.innerHTML = `
          <td colspan="8" style="text-align: center; padding: 40px; color: var(--ghs-gray);">
            <span class="material-icons" style="font-size: 48px; opacity: 0.5;">search_off</span>
            <p style="margin-top: 16px;">No children found matching "${searchTerm}"</p>
            <button class="mui-button" onclick="document.getElementById('searchChild').value=''; filterChildren();" 
                    style="margin-top: 10px;">
              Clear Search
            </button>
          </td>
        `;
        tableBody.appendChild(noResultsRow);
      }
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'N/A';
      return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }

    function callMother(phoneNumber) {
      const cleanNumber = phoneNumber.replace(/[^0-9\+]/g, '');
      if (!cleanNumber || cleanNumber.length < 10) {
        showNotification('Invalid phone number', 'error');
        return;
      }
      const telLink = `tel:${cleanNumber}`;
      const link = document.createElement('a');
      link.href = telLink;
      link.click();
      showNotification(`Calling ${phoneNumber}...`, 'info');
    }

    function showTodayAppointments() {
      const today = new Date().toISOString().split('T')[0];
      const appointments = appData.children.filter(child => 
        child.nextVisit === today && (child.ageInMonths || calculateAgeInMonths(child.dob)) < 60
      );
      const modalContent = document.getElementById('todayAppointmentsContent');
      modalContent.innerHTML = `
        <h3>Appointments for Today (${formatDate(today)})</h3>
        ${appointments.length > 0 ? `
          <table class="mui-table" style="margin-top: 10px;">
            <thead>
              <tr>
                <th>Name</th>
                <th>Age</th>
                <th>Mother</th>
                <th>Telephone/Address</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              ${appointments.map(child => {
                const telephoneAddress = child.telephoneAddress || child.motherPhone || child.address || 'N/A';
                const isPhoneNumber = /^[0-9\-\+\s\(\)]{10,}$/.test(telephoneAddress.replace(/\s/g, ''));
                return `
                  <tr>
                    <td>${child.name}</td>
                    <td>${calculateAge(child.dob)}</td>
                    <td>${child.motherName}</td>
                    <td>
                      ${telephoneAddress}
                      ${isPhoneNumber ? `
                        <button class="call-button" onclick="callMother('${telephoneAddress.replace(/'/g, "\\'")}')" title="Call mother">
                          <span class="material-icons" style="font-size: 14px;">call</span>
                        </button>
                      ` : ''}
                    </td>
                    <td>
                      <button class="mui-button" style="padding: 4px 8px; font-size: 12px;" 
                              onclick="updateChildImmunization('${child.id}'); closeModal('todayAppointmentsModal')">
                        Update
                      </button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          <p style="margin-top: 10px; color: var(--ghs-gray);">
            Total: ${appointments.length} appointment(s)
          </p>
        ` : '<p>No appointments scheduled for today.</p>'}
        <div style="margin-top: 20px;">
          <button class="mui-button secondary" onclick="closeModal('todayAppointmentsModal')">
            <span class="material-icons">close</span> Close
          </button>
        </div>
      `;
      showModal('todayAppointmentsModal');
    }

    function updateStats() {
      const stats = calculateStats();
      document.getElementById('totalChildren').textContent = stats.totalChildren;
      document.getElementById('vaccinatedToday').textContent = stats.vaccinatedToday;
      document.getElementById('dueSoon').textContent = stats.dueSoon;
      document.getElementById('defaulters').textContent = stats.defaulters;
      document.getElementById('dashboardDefaulters').textContent = stats.defaulters;
      document.getElementById('fullyImmunized').textContent = stats.fullyImmunized;
      document.getElementById('coverageRate').textContent = `${stats.coverageRate}%`;
      document.getElementById('dropoutRate').textContent = `${stats.dropoutRate}%`;
      statsCache = {
        timestamp: Date.now(),
        data: stats
      };
    }

    function calculateStats() {
      const today = new Date().toISOString().split('T')[0];
      const activeChildren = appData.children.filter(child => {
        const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
        return ageInMonths < 60;
      });
      const totalChildren = activeChildren.length;
      const vaccinatedTodaySet = new Set();
      let dueSoon = 0;
      let defaultersCount = appData.defaulters.length;
      let fullyImmunized = 0;
      let zeroDose = 0;
      activeChildren.forEach(child => {
        if (child.vaccinations) {
          const hasVaccinationToday = child.vaccinations.some(vaccination => 
            vaccination.date === today
          );
          if (hasVaccinationToday) {
            vaccinatedTodaySet.add(child.id);
          }
        }
        if (child.nextVisit) {
          const nextVisitDate = new Date(child.nextVisit);
          const todayDate = new Date();
          const daysUntilVisit = Math.ceil((nextVisitDate - todayDate) / (1000 * 60 * 60 * 24));
          if (daysUntilVisit <= 7 && daysUntilVisit > 0) {
            dueSoon++;
          }
        }
        const schedule = child.immunizationSchedule || generateImmunizationSchedule(child.dob);
        const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
        const ageAppropriateVaccines = schedule.filter(v => {
          const vaccineAgeMonths = v.ageDays / 30.44;
          return vaccineAgeMonths <= ageInMonths;
        }).length;
        const ageAppropriateGiven = schedule.filter(v => {
          const vaccineAgeMonths = v.ageDays / 30.44;
          return vaccineAgeMonths <= ageInMonths && v.status === 'given';
        }).length;
        if (ageAppropriateGiven >= ageAppropriateVaccines * 0.9) {
          fullyImmunized++;
        }
        if (!child.vaccinations || child.vaccinations.length === 0) {
          zeroDose++;
        }
      });
      const vaccinatedToday = vaccinatedTodaySet.size;
      const coverageRate = totalChildren > 0 ? 
        Math.round(((totalChildren - zeroDose) / totalChildren) * 100) : 0;
      const dropoutRate = totalChildren > 0 ? 
        Math.round((defaultersCount / totalChildren) * 100) : 0;
      return {
        totalChildren,
        vaccinatedToday,
        dueSoon,
        defaulters: defaultersCount,
        fullyImmunized,
        zeroDose,
        coverageRate,
        dropoutRate
      };
    }

    function clearAllData() {
      showModal('clearDataModal');
    }

    async function confirmClearAllData() {
      if (!currentUser || currentUser.role !== 'admin') {
        showNotification('Only administrators can clear all data.', 'error');
        return;
      }
      if (!confirm('FINAL WARNING: This will delete ALL children records. Are you absolutely sure?')) {
        return;
      }
      try {
        showLoading('Clearing all data...');
        const childrenRef = firestore.collection(db, 'child_health_register');
        const q = firestore.query(
          childrenRef,
          firestore.where('facilityId', '==', currentFacility.id)
        );
        const querySnapshot = await firestore.getDocs(q);
        const batch = firestore.writeBatch(db);
        let batchCount = 0;
        querySnapshot.forEach((doc) => {
          batch.delete(doc.ref);
          batchCount++;
          if (batchCount === 500) {
            batch.commit();
            batchCount = 0;
          }
        });
        if (batchCount > 0) {
          await batch.commit();
        }
        appData.children = [];
        appData.defaulters = [];
        const counterRef = firestore.doc(db, `facilities/${currentFacility.id}/counters/registration`);
        await firestore.updateDoc(counterRef, {
          sequence: 0,
          updatedAt: firestore.serverTimestamp()
        });
        updateStats();
        updateChildrenTable();
        updateDefaultersListEnhanced();
        closeModal('clearDataModal');
        showNotification(`All data cleared successfully! ${querySnapshot.size} records deleted.`, 'success');
      } catch (error) {
        showNotification('Failed to clear data: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function clearAllDefaulters() {
      if (!confirm('Clear all defaulters? This will update all overdue vaccines to "missed" status.')) {
        return;
      }
      try {
        showLoading('Clearing defaulters...');
        const batch = firestore.writeBatch(db);
        let updatedCount = 0;
        for (const defaulter of appData.defaulters) {
          const child = appData.children.find(c => c.id === defaulter.childId);
          if (child) {
            const updatedSchedule = [...child.immunizationSchedule];
            updatedSchedule.forEach(vaccine => {
              if (vaccine.status === 'pending') {
                const dueDate = new Date(vaccine.dueDate);
                const today = new Date();
                const daysOverdue = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                if (daysOverdue > 7) {
                  vaccine.status = 'missed';
                  vaccine.updatedAt = new Date().toISOString();
                  vaccine.remarks = 'Marked as missed during defaulter clearance';
                }
              }
            });
            const childRef = firestore.doc(db, `child_health_register/${defaulter.childId}`);
            batch.update(childRef, {
              immunizationSchedule: updatedSchedule,
              isDefaulter: false,
              updatedAt: firestore.serverTimestamp()
            });
            updatedCount++;
          }
        }
        await batch.commit();
        await loadUserData();
        showNotification(`${updatedCount} defaulters cleared!`, 'success');
      } catch (error) {
        showNotification('Failed to clear defaulters: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    function showSection(sectionId) {
      document.querySelectorAll('section').forEach(section => {
        section.style.display = 'none';
        section.classList.remove('active-section');
      });
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = 'block';
        section.classList.add('active-section');
        updateActiveNavLink(sectionId);
        if (sectionId === 'dashboard') {
          setTimeout(() => {
            initializeCharts();
          }, 100);
        } else if (sectionId === 'reporting') {
          generateEnhancedReport();
        } else if (sectionId === 'registration') {
          generateNextRegistrationNumber();
          document.getElementById('duplicateCheckMessage').style.display = 'none';
          document.getElementById('ageValidationMessage').style.display = 'none';
        } else if (sectionId === 'accountManagement') {
          updateAccountProfile();
        } else if (sectionId === 'defaulters') {
          updateDefaultersListEnhanced();
        }
        window.scrollTo(0, 0);
      }
    }

    function updateActiveNavLink(sectionId) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      document.querySelectorAll('.mobile-nav-link').forEach(link => {
        link.classList.remove('active');
      });
      const activeLink = document.querySelector(`.nav-link[onclick*="${sectionId}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
      }
      const mobileActiveLink = document.querySelector(`.mobile-nav-link[onclick*="${sectionId}"]`);
      if (mobileActiveLink) {
        mobileActiveLink.classList.add('active');
      }
    }

    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenu');
      mobileMenu.style.display = mobileMenu.style.display === 'block' ? 'none' : 'block';
    }

    function toggleAuthForm() {
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const forgotForm = document.getElementById('forgotPasswordForm');
      const switchText = document.getElementById('switchText');
      const switchLink = document.getElementById('switchLink');
      if (loginForm.style.display !== 'none') {
        loginForm.style.display = 'none';
        signupForm.style.display = 'flex';
        switchText.textContent = 'Already have an account? ';
        switchLink.textContent = 'Login';
      } else {
        loginForm.style.display = 'flex';
        signupForm.style.display = 'none';
        switchText.textContent = 'Don\'t have an account? ';
        switchLink.textContent = 'Sign up';
      }
      forgotForm.style.display = 'none';
    }

    function showForgotPassword() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('forgotPasswordForm').style.display = 'flex';
      document.getElementById('switchText').textContent = '';
      document.getElementById('switchLink').textContent = 'Back to Login';
    }

    function showLogin() {
      document.getElementById('loginForm').style.display = 'flex';
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('forgotPasswordForm').style.display = 'none';
      document.getElementById('switchText').textContent = 'Don\'t have an account? ';
      document.getElementById('switchLink').textContent = 'Sign up';
    }

    function updateUserInterface() {
      if (!currentUser) return;
      document.getElementById('currentUserName').textContent = currentUser.name;
      document.getElementById('currentUserEmail').textContent = currentUser.email;
      if (currentFacility) {
        document.getElementById('currentFacility').textContent = currentFacility.name;
        const facilityNameInput = document.getElementById('facilityName');
        if (facilityNameInput) {
          facilityNameInput.value = currentFacility.name;
        }
      }
      const userManagementSection = document.getElementById('userManagementSection');
      if (userManagementSection) {
        userManagementSection.style.display = currentUser.role === 'admin' ? 'block' : 'none';
      }
    }

    function updateAccountProfile() {
      if (!currentUser) return;
      document.getElementById('profileName').value = currentUser.name;
      document.getElementById('profileEmail').value = currentUser.email;
      document.getElementById('profilePhone').value = currentUser.phone || '';
      document.getElementById('profileRole').value = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
      if (currentUser.createdAt) {
        document.getElementById('profileCreated').value = currentUser.createdAt.toLocaleDateString();
      }
      if (currentUser.lastLogin) {
        document.getElementById('profileLastLogin').value = currentUser.lastLogin.toLocaleString();
      }
    }

    function showAuthError(elementId, message) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = message;
        element.style.display = 'block';
      }
    }

    function clearAuthErrors() {
      document.querySelectorAll('.auth-error').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
    }

    function clearAuthForms() {
      document.getElementById('loginForm')?.reset();
      document.getElementById('signupForm')?.reset();
      document.getElementById('forgotPasswordForm')?.reset();
      clearAuthErrors();
    }

    function checkPasswordStrength(password, barId) {
      const bar = document.getElementById(barId);
      if (!bar) return;
      let strength = 0;
      if (password.length >= 8) strength += 25;
      if (password.length >= 12) strength += 25;
      if (/[A-Z]/.test(password)) strength += 20;
      if (/[0-9]/.test(password)) strength += 20;
      if (/[^A-Za-z0-9]/.test(password)) strength += 10;
      bar.style.width = strength + '%';
      bar.className = 'password-strength-bar';
      if (strength < 50) {
        bar.classList.add('strength-weak');
      } else if (strength < 75) {
        bar.classList.add('strength-fair');
      } else if (strength < 90) {
        bar.classList.add('strength-good');
      } else {
        bar.classList.add('strength-strong');
      }
    }

    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('show');
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('show');
      }
    }

    function showNotification(message, type = 'info') {
      const notificationArea = document.getElementById('notificationArea');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} 
        ${message}
      `;
      notificationArea.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }

    function showLoading(message = 'Loading...') {
      const loading = document.getElementById('loadingIndicator');
      const messageEl = document.getElementById('loadingMessage');
      messageEl.textContent = message;
      loading.style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingIndicator').style.display = 'none';
    }

    function checkOnlineStatus() {
      const offlineIndicator = document.getElementById('offlineIndicator');
      if (!navigator.onLine) {
        offlineIndicator.style.display = 'block';
        showNotification('You are offline. Working in offline mode...', 'warning');
        if ('serviceWorker' in navigator && 'SyncManager' in window) {
          navigator.serviceWorker.ready.then((registration) => {
            registration.sync.register('sync-children');
          });
        }
      } else {
        offlineIndicator.style.display = 'none';
        if (currentUser && appData.lastSync) {
          const now = new Date();
          const diffMinutes = (now - appData.lastSync) / (1000 * 60);
          if (diffMinutes > 1) {
            loadUserData();
            appData.lastSync = now;
            document.getElementById('lastSynced').textContent = now.toLocaleTimeString();
            showNotification('Back online! Syncing data...', 'success');
          }
        }
      }
    }

    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const toggleBtn = input?.nextElementSibling;
      if (input && toggleBtn) {
        if (input.type === 'password') {
          input.type = 'text';
          toggleBtn.textContent = 'üôà';
        } else {
          input.type = 'password';
          toggleBtn.textContent = 'üëÅÔ∏è';
        }
      }
    }

    function initializePWA() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  showNotification('New version available! Refresh to update.', 'info');
                }
              });
            });
          });
      }
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallPrompt();
      });
      window.addEventListener('appinstalled', () => {
        const installBtn = document.getElementById('installPWAButton');
        if (installBtn) installBtn.style.display = 'none';
        showNotification('App installed successfully!', 'success');
      });
    }

    function showInstallPrompt() {
      const installBtn = document.getElementById('installPWAButton');
      if (installBtn) {
        setTimeout(() => {
          if (deferredPrompt) {
            installBtn.style.display = 'block';
          }
        }, 5000);
        setTimeout(() => {
          installBtn.style.display = 'none';
        }, 30000);
      }
    }

    async function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        const installBtn = document.getElementById('installPWAButton');
        if (installBtn) installBtn.style.display = 'none';
      }
    }

    window.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
      }
    });

    async function handleProfileUpdate(e) {
      e.preventDefault();
      if (!currentUser) return;
      const name = document.getElementById('profileName').value;
      const phone = document.getElementById('profilePhone').value;
      try {
        showLoading('Updating profile...');
        const userRef = firestore.doc(db, `users/${currentUser.uid}`);
        await firestore.updateDoc(userRef, {
          name: name,
          phone: phone,
          updatedAt: firestore.serverTimestamp()
        });
        currentUser.name = name;
        currentUser.phone = phone;
        updateUserInterface();
        showNotification('Profile updated successfully!', 'success');
      } catch (error) {
        showNotification('Failed to update profile: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function handleChangePassword(e) {
      e.preventDefault();
      if (!currentUser) return;
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      clearAuthErrors();
      if (!currentPassword || !newPassword || !confirmPassword) {
        showAuthError('currentPasswordError', 'Please fill in all fields');
        return;
      }
      if (newPassword !== confirmPassword) {
        showAuthError('confirmPasswordError', 'New passwords do not match');
        return;
      }
      if (newPassword.length < 6) {
        showAuthError('newPasswordError', 'New password must be at least 6 characters');
        return;
      }
      try {
        showLoading('Changing password...');
        const credential = window.firebase.auth.EmailAuthProvider.credential(
          currentUser.email,
          currentPassword
        );
        await window.firebase.auth.reauthenticateWithCredential(auth.currentUser, credential);
        await window.firebase.auth.updatePassword(auth.currentUser, newPassword);
        document.getElementById('changePasswordForm').reset();
        showNotification('Password changed successfully!', 'success');
      } catch (error) {
        let errorMessage = 'Failed to change password.';
        switch (error.code) {
          case 'auth/wrong-password':
            errorMessage = 'Current password is incorrect.';
            showAuthError('currentPasswordError', errorMessage);
            break;
          case 'auth/weak-password':
            errorMessage = 'New password is too weak.';
            showAuthError('newPasswordError', errorMessage);
            break;
          default:
            showNotification(errorMessage + ' ' + error.message, 'error');
        }
      } finally {
        hideLoading();
      }
    }

    async function deleteAccount() {
      if (!confirm('Are you sure you want to delete your account? This action cannot be undone and will delete all your data.')) {
        return;
      }
      try {
        showLoading('Deleting account...');
        await window.firebase.auth.deleteFirebaseUser(auth.currentUser);
        const userRef = firestore.doc(db, `users/${currentUser.uid}`);
        await firestore.deleteDoc(userRef);
        await logout();
        showNotification('Account deleted successfully.', 'success');
      } catch (error) {
        showNotification('Failed to delete account: ' + error.message, 'error');
        hideLoading();
      }
    }

    function exportAccountData() {
      const data = {
        user: currentUser,
        facility: currentFacility,
        children: appData.children,
        defaulters: appData.defaulters,
        settings: appData.settings,
        exportedAt: new Date().toISOString()
      };
      const dataStr = JSON.stringify(data, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const link = document.createElement('a');
      link.setAttribute('href', dataUri);
      link.setAttribute('download', `account_backup_${new Date().toISOString().split('T')[0]}.json`);
      link.click();
      showNotification('Account data exported successfully!', 'success');
    }

    function initializeEnhancedSettings() {
      loadFeatureFlags();
    }

    function toggleFeatureFlag(flagName, enabled) {
      localStorage.setItem(flagName, enabled.toString());
      showNotification(`Feature flag updated: ${flagName} = ${enabled}`, 'info');
    }

    function loadFeatureFlags() {
      const flags = [
        'ipv2_enabled',
        'malaria_vaccine_enabled'
      ];
      flags.forEach(flag => {
        const element = document.getElementById(flag);
        if (element) {
          element.checked = localStorage.getItem(flag) === 'true';
        }
      });
    }

    async function saveSettings() {
      if (!currentFacility) return;
      const facilityName = document.getElementById('facilityName').value;
      const reminderDays = document.getElementById('reminderDays').value;
      const language = document.getElementById('language').value;
      const syncFrequency = document.getElementById('syncFrequency').value;
      try {
        showLoading('Saving settings...');
        const facilityRef = firestore.doc(db, `facilities/${currentFacility.id}`);
        await firestore.updateDoc(facilityRef, {
          name: facilityName,
          settings: {
            reminderDays: parseInt(reminderDays),
            language: language,
            syncFrequency: syncFrequency
          },
          updatedAt: firestore.serverTimestamp()
        });
        currentFacility.name = facilityName;
        currentFacility.settings = {
          reminderDays: parseInt(reminderDays),
          language: language,
          syncFrequency: syncFrequency
        };
        updateUserInterface();
        showNotification('Settings saved successfully!', 'success');
      } catch (error) {
        showNotification('Failed to save settings: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    function exportData() {
      exportAccountData();
    }

    function clearCache() {
      localStorage.clear();
      showNotification('Cache cleared successfully!', 'success');
      setTimeout(() => {
        location.reload();
      }, 1000);
    }

    function switchReportTab(tabName) {
      document.querySelectorAll('.mui-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.report-content').forEach(content => {
        content.style.display = 'none';
      });
      const tabButton = document.querySelector(`.mui-tab[onclick*="${tabName}"]`);
      if (tabButton) {
        tabButton.classList.add('active');
      }
      const reportDiv = document.getElementById(`${tabName}Report`);
      if (reportDiv) {
        reportDiv.style.display = 'block';
      }
      generateEnhancedReport(tabName);
    }

    function generateEnhancedReport(tabName = 'summary') {
      if (tabName === 'summary') {
        generateSummaryReport();
      } else if (tabName === 'detailed') {
        generateDetailedReport();
      } else if (tabName === 'vaccine') {
        generateVaccineReport();
      } else if (tabName === 'defaulters') {
        generateDefaultersReport();
      }
    }

    function generateSummaryReport() {
      const period = document.getElementById('reportPeriod').value;
      const now = new Date();
      let startDate = new Date();
      switch (period) {
        case 'today':
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'week':
          startDate.setDate(startDate.getDate() - 7);
          break;
        case 'month':
          startDate.setMonth(startDate.getMonth() - 1);
          break;
        case 'quarter':
          startDate.setMonth(startDate.getMonth() - 3);
          break;
        case 'year':
          startDate.setFullYear(startDate.getFullYear() - 1);
          break;
      }
      let totalVaccinations = 0;
      let defaulters = appData.defaulters.length;
      appData.children.forEach(child => {
        if (child.vaccinations) {
          child.vaccinations.forEach(vaccination => {
            const vaccDate = new Date(vaccination.date);
            if (vaccDate >= startDate && vaccDate <= now) {
              totalVaccinations++;
            }
          });
        }
      });
      const totalChildren = appData.children.filter(child => {
        const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
        return ageInMonths < 60;
      }).length;
      const completionRate = totalChildren > 0 ? 
        Math.round((appData.children.filter(c => {
          const ageInMonths = c.ageInMonths || calculateAgeInMonths(c.dob);
          if (ageInMonths >= 60) return false;
          const schedule = c.immunizationSchedule || generateImmunizationSchedule(c.dob);
          const ageAppropriateVaccines = schedule.filter(v => {
            const vaccineAgeMonths = v.ageDays / 30.44;
            return vaccineAgeMonths <= ageInMonths;
          }).length;
          const ageAppropriateGiven = schedule.filter(v => {
            const vaccineAgeMonths = v.ageDays / 30.44;
            return vaccineAgeMonths <= ageInMonths && v.status === 'given';
          }).length;
          return ageAppropriateGiven >= ageAppropriateVaccines * 0.9;
        }).length / totalChildren) * 100) : 0;
      const coverageRate = totalChildren > 0 ? 
        Math.round((appData.children.filter(c => {
          const ageInMonths = c.ageInMonths || calculateAgeInMonths(c.dob);
          if (ageInMonths >= 60) return false;
          return c.vaccinations && c.vaccinations.length > 0;
        }).length / totalChildren) * 100) : 0;
      document.getElementById('reportTotal').textContent = totalVaccinations;
      document.getElementById('reportDefaulters').textContent = defaulters;
      document.getElementById('reportCompletion').textContent = `${completionRate}%`;
      document.getElementById('reportCoverage').textContent = `${coverageRate}%`;
      updateReportCharts();
    }

    function updateReportCharts() {
      const trendCtx = document.getElementById('trendChart');
      if (trendCtx) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthlyVaccinations = new Array(12).fill(0);
        appData.children.forEach(child => {
          if (child.vaccinations) {
            child.vaccinations.forEach(vaccination => {
              const month = new Date(vaccination.date).getMonth();
              monthlyVaccinations[month]++;
            });
          }
        });
        new Chart(trendCtx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Vaccinations',
              data: monthlyVaccinations,
              borderColor: '#006400',
              backgroundColor: 'rgba(0, 100, 0, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
      const ageCtx = document.getElementById('ageChart');
      if (ageCtx) {
        const ageGroups = {
          '0-6 months': 0,
          '7-12 months': 0,
          '1-2 years': 0,
          '2-5 years': 0
        };
        appData.children.forEach(child => {
          const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
          if (ageInMonths <= 6) {
            ageGroups['0-6 months']++;
          } else if (ageInMonths <= 12) {
            ageGroups['7-12 months']++;
          } else if (ageInMonths <= 24) {
            ageGroups['1-2 years']++;
          } else if (ageInMonths < 60) {
            ageGroups['2-5 years']++;
          }
        });
        new Chart(ageCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(ageGroups),
            datasets: [{
              data: Object.values(ageGroups),
              backgroundColor: ['#006400', '#FFD700', '#CE1126', '#0066CC'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    }

    function generateDetailedReport() {
      const tableBody = document.getElementById('detailedReportBody');
      if (!tableBody) return;
      tableBody.innerHTML = '';
      appData.children.forEach(child => {
        if (child.vaccinations) {
          child.vaccinations.forEach(vaccination => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${formatDate(vaccination.date)}</td>
              <td>${child.name}</td>
              <td>${vaccination.vaccine}</td>
              <td>${getDoseNumber(vaccination.vaccine)}</td>
              <td>${vaccination.givenBy}</td>
              <td>${currentFacility?.name || 'N/A'}</td>
            `;
            tableBody.appendChild(row);
          });
        }
      });
    }

    function getDoseNumber(vaccineName) {
      const vaccine = vaccineSchedule.find(v => v.name === vaccineName);
      return vaccine ? vaccine.dose : 'N/A';
    }

    function generateVaccineReport() {
      const content = document.getElementById('vaccineReportContent');
      if (!content) return;
      const vaccineCounts = {};
      vaccineSchedule.forEach(vaccine => {
        vaccineCounts[vaccine.name] = 0;
      });
      appData.children.forEach(child => {
        if (child.vaccinations) {
          child.vaccinations.forEach(vaccination => {
            if (vaccineCounts[vaccination.vaccine] !== undefined) {
              vaccineCounts[vaccination.vaccine]++;
            }
          });
        }
      });
      const totalChildren = appData.children.filter(child => {
        const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
        return ageInMonths < 60;
      }).length;
      let html = '<h3>Vaccine Coverage Report</h3>';
      html += '<table class="mui-table" style="margin-top: 10px;">';
      html += '<thead><tr><th>Vaccine</th><th>Dose</th><th>Given</th><th>Coverage</th><th>Target Age</th></tr></thead>';
      html += '<tbody>';
      vaccineSchedule.forEach(vaccine => {
        const given = vaccineCounts[vaccine.name];
        const coverage = totalChildren > 0 ? 
          Math.round((given / totalChildren) * 100) : 0;
        const targetAge = vaccine.ageDays === 0 ? 'Birth' : 
                         vaccine.ageDays <= 42 ? '6 Weeks' :
                         vaccine.ageDays <= 70 ? '10 Weeks' :
                         vaccine.ageDays <= 98 ? '14 Weeks' :
                         vaccine.ageDays <= 180 ? '6 Months' :
                         vaccine.ageDays <= 210 ? '7 Months' :
                         vaccine.ageDays <= 270 ? '9 Months' :
                         vaccine.ageDays <= 365 ? '12 Months' :
                         vaccine.ageDays <= 540 ? '18 Months' :
                         `${Math.round(vaccine.ageDays / 30.44)} Months`;
        html += `
          <tr>
            <td>${vaccine.name}</td>
            <td>${vaccine.dose}</td>
            <td>${given}</td>
            <td>${coverage}%</td>
            <td>${targetAge}</td>
          </tr>
        `;
      });
      html += '</tbody></table>';
      content.innerHTML = html;
    }

    function generateDefaultersReport() {
      const content = document.getElementById('defaultersReportContent');
      if (!content) return;
      let html = '<h3>Comprehensive Defaulters Report</h3>';
      html += '<div style="margin-bottom: 20px;">';
      html += `<p><strong>Report Date:</strong> ${new Date().toLocaleDateString()}</p>`;
      html += `<p><strong>Total Defaulters:</strong> ${appData.defaulters.length}</p>`;
      html += '</div>';
      if (appData.defaulters.length > 0) {
        const avgDaysOverdue = Math.round(appData.defaulters.reduce((sum, d) => sum + d.daysOverdue, 0) / appData.defaulters.length);
        const communitiesCount = [...new Set(appData.defaulters.map(d => d.community))].length;
        html += `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="background: #fff8e1; padding: 15px; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0; color: #5d4037;">Average Days Overdue</h4>
              <div style="font-size: 24px; font-weight: bold; color: #ef6c00;">${avgDaysOverdue}</div>
            </div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0; color: #2e7d32;">Communities Affected</h4>
              <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">${communitiesCount}</div>
            </div>
          </div>
        `;
        html += '<div style="overflow-x: auto;">';
        html += '<table class="mui-table">';
        html += '<thead><tr><th>#</th><th>Child</th><th>Mother</th><th>Community</th><th>Missed Vaccine(s)</th><th>Due Date</th><th>Days Overdue</th></tr></thead>';
        html += '<tbody>';
        appData.defaulters.forEach((defaulter, index) => {
          html += `
            <tr>
              <td>${index + 1}</td>
              <td>${defaulter.childName}</td>
              <td>${defaulter.motherName}</td>
              <td>${defaulter.community}</td>
              <td>${defaulter.missedVaccine}</td>
              <td>${formatDate(defaulter.dueDate)}</td>
              <td><span class="mui-chip defaulted">${defaulter.daysOverdue} days</span></td>
            </tr>
          `;
        });
        html += '</tbody></table></div>';
      } else {
        html += '<div style="text-align: center; padding: 40px; color: var(--ghs-gray);">';
        html += '<span class="material-icons" style="font-size: 48px; opacity: 0.5;">check_circle</span>';
        html += '<p style="margin-top: 16px;">No defaulters found. Excellent work!</p>';
        html += '</div>';
      }
      content.innerHTML = html;
    }

    function exportToExcel() {
      exportChildrenToExcel();
    }

    function printReport() {
      window.print();
    }

    function initializeCharts() {
      const vaccinationCtx = document.getElementById('vaccinationChart');
      if (vaccinationCtx) {
        const activeChildren = appData.children.filter(child => {
          const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
          return ageInMonths < 60;
        });
        const fullyImmunized = activeChildren.filter(child => {
          const schedule = child.immunizationSchedule || generateImmunizationSchedule(child.dob);
          const ageInMonths = child.ageInMonths || calculateAgeInMonths(child.dob);
          const ageAppropriateVaccines = schedule.filter(v => {
            const vaccineAgeMonths = v.ageDays / 30.44;
            return vaccineAgeMonths <= ageInMonths;
          }).length;
          const ageAppropriateGiven = schedule.filter(v => {
            const vaccineAgeMonths = v.ageDays / 30.44;
            return vaccineAgeMonths <= ageInMonths && v.status === 'given';
          }).length;
          return ageAppropriateGiven >= ageAppropriateVaccines * 0.9;
        }).length;
        const partiallyImmunized = activeChildren.filter(child => {
          const schedule = child.immunizationSchedule || generateImmunizationSchedule(child.dob);
          const givenVaccines = schedule.filter(v => v.status === 'given').length;
          return givenVaccines > 0 && givenVaccines < schedule.length * 0.9;
        }).length;
        const notImmunized = activeChildren.filter(child => {
          const schedule = child.immunizationSchedule || generateImmunizationSchedule(child.dob);
          const givenVaccines = schedule.filter(v => v.status === 'given').length;
          return givenVaccines === 0;
        }).length;
        new Chart(vaccinationCtx, {
          type: 'pie',
          data: {
            labels: ['Fully Immunized', 'Partially Immunized', 'Not Immunized'],
            datasets: [{
              data: [fullyImmunized, partiallyImmunized, notImmunized],
              backgroundColor: ['#006400', '#FFD700', '#CE1126'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
      const defaultersCtx = document.getElementById('defaultersChart');
      if (defaultersCtx) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthlyDefaulters = new Array(12).fill(0);
        const currentMonth = new Date().getMonth();
        monthlyDefaulters[currentMonth] = appData.defaulters.length;
        new Chart(defaultersCtx, {
          type: 'bar',
          data: {
            labels: months,
            datasets: [{
              label: 'Defaulters',
              data: monthlyDefaulters,
              backgroundColor: '#CE1126',
              borderColor: '#a00',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
      const recentActivityBody = document.getElementById('recentActivityBody');
      if (recentActivityBody) {
        recentActivityBody.innerHTML = '';
        const recentVaccinations = [];
        appData.children.forEach(child => {
          if (child.vaccinations) {
            child.vaccinations.forEach(vaccination => {
              recentVaccinations.push({
                date: vaccination.date,
                childName: child.name,
                vaccine: vaccination.vaccine,
                givenBy: vaccination.givenBy || 'Unknown'
              });
            });
          }
        });
        recentVaccinations.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recent = recentVaccinations.slice(0, 5);
        if (recent.length > 0) {
          recent.forEach(vaccination => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${formatDate(vaccination.date)}</td>
              <td>${vaccination.childName}</td>
              <td>${vaccination.vaccine}</td>
              <td><span class="mui-chip completed">Given</span></td>
              <td>${vaccination.givenBy}</td>
            `;
            recentActivityBody.appendChild(row);
          });
        } else {
          recentActivityBody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 20px; color: var(--ghs-gray);">
                No recent vaccination activity
              </td>
            </tr>
          `;
        }
      }
    }

    function cancelEdit() {
      document.getElementById('registerChildForm').reset();
      document.getElementById('childId').value = '';
      document.getElementById('duplicateCheckMessage').style.display = 'none';
      document.getElementById('ageValidationMessage').style.display = 'none';
      document.getElementById('registrationTitle').textContent = 'üë∂ Register New Child (0-59 months only)';
      document.getElementById('registerButton').innerHTML = '<span class="material-icons">save</span> Register Child with Immunization Schedule';
      document.getElementById('cancelEditButton').style.display = 'none';
      const editButton = document.getElementById('editChildButton');
      if (editButton) editButton.remove();
      generateNextRegistrationNumber();
    }

    function showAddUserModal() {
      if (currentUser.role !== 'admin') {
        showNotification('Only administrators can add new users.', 'error');
        return;
      }
      document.getElementById('addUserForm').reset();
      document.getElementById('newUserPassword').value = '';
      document.getElementById('newUserConfirmPassword').value = '';
      togglePermissions();
      showModal('addUserModal');
    }

    function togglePermissions() {
      const role = document.getElementById('newUserRole').value;
      const isAdmin = role === 'admin';
      const isViewer = role === 'viewer';
      document.getElementById('permManage').disabled = !isAdmin;
      document.getElementById('permDelete').disabled = isViewer;
      if (role === 'admin') {
        document.querySelectorAll('#addUserForm input[type="checkbox"]').forEach(cb => {
          cb.checked = true;
        });
      } else if (role === 'viewer') {
        document.getElementById('permView').checked = true;
        document.getElementById('permRegister').checked = false;
        document.getElementById('permVaccinate').checked = false;
        document.getElementById('permEdit').checked = false;
        document.getElementById('permDelete').checked = false;
        document.getElementById('permReports').checked = false;
        document.getElementById('permExport').checked = false;
      } else {
        document.getElementById('permRegister').checked = true;
        document.getElementById('permVaccinate').checked = true;
        document.getElementById('permView').checked = true;
        document.getElementById('permEdit').checked = true;
        document.getElementById('permDelete').checked = false;
        document.getElementById('permReports').checked = true;
        document.getElementById('permExport').checked = true;
      }
    }

    async function handleAddUser(e) {
      e.preventDefault();
      if (!currentUser || currentUser.role !== 'admin') {
        showNotification('Only administrators can add new users.', 'error');
        return;
      }
      const name = document.getElementById('newUserName').value.trim();
      const email = document.getElementById('newUserEmail').value.trim();
      const phone = document.getElementById('newUserPhone').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const confirmPassword = document.getElementById('newUserConfirmPassword').value;
      const role = document.getElementById('newUserRole').value;
      const notes = document.getElementById('newUserNotes').value.trim();
      if (!name || !email || !password || !confirmPassword || !role) {
        showNotification('Please fill in all required fields.', 'error');
        return;
      }
      if (password !== confirmPassword) {
        showNotification('Passwords do not match.', 'error');
        return;
      }
      if (password.length < 6) {
        showNotification('Password must be at least 6 characters.', 'error');
        return;
      }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showNotification('Please enter a valid email address.', 'error');
        return;
      }
      const existingUser = appData.users.find(u => u.email.toLowerCase() === email.toLowerCase());
      if (existingUser) {
        showNotification('A user with this email already exists.', 'error');
        return;
      }
      try {
        showLoading('Creating user account...');
        const permissions = {
          register: document.getElementById('permRegister').checked,
          vaccinate: document.getElementById('permVaccinate').checked,
          view: document.getElementById('permView').checked,
          edit: document.getElementById('permEdit').checked,
          delete: document.getElementById('permDelete').checked,
          reports: document.getElementById('permReports').checked,
          export: document.getElementById('permExport').checked,
          manage: document.getElementById('permManage').checked && role === 'admin'
        };
        const userCredential = await window.firebase.auth.createUserWithEmailAndPassword(auth, email, password);
        const newUser = userCredential.user;
        const userRef = firestore.doc(db, `users/${newUser.uid}`);
        await firestore.setDoc(userRef, {
          name: name,
          email: email,
          phone: phone || '',
          facilityId: currentFacility.id,
          role: role,
          status: 'active',
          permissions: permissions,
          notes: notes || '',
          createdBy: currentUser.uid,
          createdAt: firestore.serverTimestamp(),
          lastLogin: null,
          passwordChanged: false
        });
        closeModal('addUserModal');
        document.getElementById('addUserForm').reset();
        await loadUsers();
        showNotification(`User ${name} created successfully!`, 'success');
      } catch (error) {
        let errorMessage = 'Failed to create user. Please try again.';
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMessage = 'This email is already registered.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address.';
            break;
          case 'auth/weak-password':
            errorMessage = 'Password is too weak. Please choose a stronger password.';
            break;
          case 'auth/operation-not-allowed':
            errorMessage = 'Email/password accounts are not enabled.';
            break;
        }
        showNotification(errorMessage, 'error');
      } finally {
        hideLoading();
      }
    }

    function editUser(userId) {
      const user = appData.users.find(u => u.id === userId);
      if (!user) return;
      if (user.id === currentUser.uid) {
        showNotification('You cannot edit your own account here. Use account settings.', 'info');
        return;
      }
      document.getElementById('editUserId').value = user.id;
      document.getElementById('editUserName').value = user.name || '';
      document.getElementById('editUserEmail').value = user.email || '';
      document.getElementById('editUserPhone').value = user.phone || '';
      document.getElementById('editUserRole').value = user.role || 'healthworker';
      document.getElementById('editUserNotes').value = user.notes || '';
      if (user.permissions) {
        document.getElementById('editPermRegister').checked = user.permissions.register || false;
        document.getElementById('editPermVaccinate').checked = user.permissions.vaccinate || false;
        document.getElementById('editPermView').checked = user.permissions.view || false;
        document.getElementById('editPermEdit').checked = user.permissions.edit || false;
        document.getElementById('editPermDelete').checked = user.permissions.delete || false;
        document.getElementById('editPermReports').checked = user.permissions.reports || false;
        document.getElementById('editPermExport').checked = user.permissions.export || false;
        document.getElementById('editPermManage').checked = user.permissions.manage || false;
      }
      toggleEditPermissions();
      showModal('editUserModal');
    }

    function toggleEditPermissions() {
      const role = document.getElementById('editUserRole').value;
      const isAdmin = role === 'admin';
      const isViewer = role === 'viewer';
      document.getElementById('editPermManage').disabled = !isAdmin;
      document.getElementById('editPermDelete').disabled = isViewer;
    }

    async function handleEditUser(e) {
      e.preventDefault();
      const userId = document.getElementById('editUserId').value;
      const name = document.getElementById('editUserName').value.trim();
      const email = document.getElementById('editUserEmail').value.trim();
      const phone = document.getElementById('editUserPhone').value.trim();
      const role = document.getElementById('editUserRole').value;
      const notes = document.getElementById('editUserNotes').value.trim();
      if (!userId || !name || !email || !role) {
        showNotification('Please fill in all required fields.', 'error');
        return;
      }
      try {
        showLoading('Updating user...');
        const permissions = {
          register: document.getElementById('editPermRegister').checked,
          vaccinate: document.getElementById('editPermVaccinate').checked,
          view: document.getElementById('editPermView').checked,
          edit: document.getElementById('editPermEdit').checked,
          delete: document.getElementById('editPermDelete').checked,
          reports: document.getElementById('editPermReports').checked,
          export: document.getElementById('editPermExport').checked,
          manage: document.getElementById('editPermManage').checked && role === 'admin'
        };
        const userRef = firestore.doc(db, `users/${userId}`);
        await firestore.updateDoc(userRef, {
          name: name,
          email: email,
          phone: phone || '',
          role: role,
          permissions: permissions,
          notes: notes || '',
          updatedAt: firestore.serverTimestamp(),
          updatedBy: currentUser.uid
        });
        closeModal('editUserModal');
        await loadUsers();
        showNotification('User updated successfully!', 'success');
      } catch (error) {
        showNotification('Failed to update user: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function resetUserPasswordPrompt() {
      const userId = document.getElementById('editUserId').value;
      const user = appData.users.find(u => u.id === userId);
      if (!user) return;
      const newPassword = prompt(`Reset password for ${user.name}? Enter new password (min 6 chars):`, '');
      if (!newPassword || newPassword.length < 6) {
        showNotification('Password must be at least 6 characters.', 'error');
        return;
      }
      if (confirm(`Are you sure you want to reset password for ${user.name}? They will receive an email.`)) {
        await resetUserPassword(userId, user.email, newPassword);
      }
    }

    async function resetUserPassword(userId, email, newPassword) {
      try {
        showLoading('Resetting password...');
        const userRef = firestore.doc(db, `users/${userId}`);
        await firestore.updateDoc(userRef, {
          passwordChanged: false,
          lastPasswordReset: firestore.serverTimestamp(),
          updatedAt: firestore.serverTimestamp()
        });
        showNotification(`Password reset instructions sent to ${email}`, 'success');
      } catch (error) {
        showNotification('Failed to reset password: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    function updateUsersTable() {
      const tableBody = document.getElementById('usersTableBody');
      if (!tableBody) return;
      tableBody.innerHTML = '';
      appData.users.forEach(user => {
        const row = document.createElement('tr');
        const lastLogin = user.lastLogin ? 
          user.lastLogin.toLocaleDateString() + ' ' + user.lastLogin.toLocaleTimeString().substring(0, 5) : 'Never';
        let roleBadge = '';
        switch (user.role) {
          case 'admin':
            roleBadge = '<span class="role-badge admin">Administrator</span>';
            break;
          case 'supervisor':
            roleBadge = '<span class="role-badge" style="background: #9C27B0;">Supervisor</span>';
            break;
          case 'healthworker':
            roleBadge = '<span class="role-badge staff">Health Worker</span>';
            break;
          case 'dataentry':
            roleBadge = '<span class="role-badge" style="background: #2196F3;">Data Clerk</span>';
            break;
          case 'viewer':
            roleBadge = '<span class="role-badge user">Viewer</span>';
            break;
          default:
            roleBadge = '<span class="role-badge user">User</span>';
        }
        const statusBadge = user.status === 'active' ?
          '<span class="mui-chip completed">Active</span>' :
          '<span class="mui-chip defaulted">Inactive</span>';
        row.innerHTML = `
          <td>
            <div><strong>${user.name}</strong></div>
            <small style="color: var(--ghs-gray);">${user.email}</small>
            ${user.phone ? `<div><small>üì± ${user.phone}</small></div>` : ''}
          </td>
          <td>${roleBadge}</td>
          <td>${statusBadge}</td>
          <td>${lastLogin}</td>
          <td>
            <div class="user-table-actions">
              <button class="mui-button" style="padding: 4px 8px; font-size: 12px;" 
                      onclick="editUser('${user.id}')">
                <span class="material-icons" style="font-size: 14px;">edit</span> Edit
              </button>
              ${user.id !== currentUser.uid ? `
                <button class="mui-button secondary" style="padding: 4px 8px; font-size: 12px;" 
                        onclick="toggleUserStatus('${user.id}', '${user.status}')">
                  ${user.status === 'active' ? 'Deactivate' : 'Activate'}
                </button>
                <button class="mui-button" style="padding: 4px 8px; font-size: 12px; background: #9C27B0;" 
                        onclick="resetUserPasswordPrompt('${user.id}', '${user.email}')">
                  <span class="material-icons" style="font-size: 14px;">lock_reset</span>
                </button>
                <button class="mui-button danger" style="padding: 4px 8px; font-size: 12px;" 
                        onclick="deleteUser('${user.id}')">
                  <span class="material-icons" style="font-size: 14px;">delete</span>
                </button>
              ` : ''}
            </div>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    async function toggleUserStatus(userId, currentStatus) {
      if (!confirm(`Are you sure you want to ${currentStatus === 'active' ? 'deactivate' : 'activate'} this user?`)) {
        return;
      }
      try {
        showLoading('Updating user status...');
        const userRef = firestore.doc(db, `users/${userId}`);
        await firestore.updateDoc(userRef, {
          status: currentStatus === 'active' ? 'inactive' : 'active',
          updatedAt: firestore.serverTimestamp()
        });
        await loadUsers();
        showNotification(`User ${currentStatus === 'active' ? 'deactivated' : 'activated'} successfully!`, 'success');
      } catch (error) {
        showNotification('Failed to update user status: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
      }
      try {
        showLoading('Deleting user...');
        const userRef = firestore.doc(db, `users/${userId}`);
        await firestore.deleteDoc(userRef);
        await loadUsers();
        showNotification('User deleted successfully!', 'success');
      } catch (error) {
        showNotification('Failed to delete user: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    function updateUserStatistics() {
      const totalUsers = appData.users.length;
      const activeUsers = appData.users.filter(u => u.status === 'active').length;
      const adminUsers = appData.users.filter(u => u.role === 'admin').length;
      const today = new Date().toDateString();
      const todayLogins = appData.users.filter(u => 
        u.lastLogin && new Date(u.lastLogin).toDateString() === today
      ).length;
      document.getElementById('totalUsersCount').textContent = totalUsers;
      document.getElementById('activeUsersCount').textContent = activeUsers;
      document.getElementById('adminUsersCount').textContent = adminUsers;
      document.getElementById('todayLoginsCount').textContent = todayLogins;
    }
  </script>
</body>
</html>